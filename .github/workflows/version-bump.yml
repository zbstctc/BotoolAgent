name: Version Bump

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    # Skip if the push was a tag or if commit message contains [skip ci]
    if: "!startsWith(github.ref, 'refs/tags/') && !contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for tag detection

      - name: Get latest tag
        id: latest_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Latest tag: $TAG"

      - name: Determine version bump
        id: bump
        run: |
          LATEST_TAG="${{ steps.latest_tag.outputs.tag }}"

          # Get commits since last tag
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%s" HEAD)
          else
            COMMITS=$(git log --pretty=format:"%s" "${LATEST_TAG}..HEAD")
          fi

          if [ -z "$COMMITS" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "No new commits since $LATEST_TAG"
            exit 0
          fi

          echo "Commits since $LATEST_TAG:"
          echo "$COMMITS"

          # Determine bump type from conventional commits
          BUMP="patch"

          if echo "$COMMITS" | grep -qE "^feat(\(.+\))?!:|BREAKING CHANGE:"; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
            BUMP="minor"
          fi

          # Parse current version
          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Calculate new version
          case "$BUMP" in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
          esac

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"
          echo "new_version=v${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Bump: $BUMP -> v${NEW_VERSION}"

      - name: Create tag and release
        if: steps.bump.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_TAG="${{ steps.bump.outputs.new_version }}"
          LATEST_TAG="${{ steps.latest_tag.outputs.tag }}"

          # Generate release notes from commits
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            NOTES=$(git log --pretty=format:"- %s" HEAD | head -50)
          else
            NOTES=$(git log --pretty=format:"- %s" "${LATEST_TAG}..HEAD")
          fi

          # Create annotated tag
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          git push origin "$NEW_TAG"

          # Create GitHub Release
          gh release create "$NEW_TAG" \
            --title "$NEW_TAG" \
            --notes "$NOTES" \
            --latest
