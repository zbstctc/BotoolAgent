# 应用状态管理规范

## 状态层级
1. **React Context**（全局共享状态）：项目列表、活跃项目、workspace
2. **localStorage**（持久化）：通过 `lib/project-storage.ts` 和 `lib/prd-session-storage.ts` 管理
3. **组件 state**（局部状态）：表单输入、UI 开关、临时数据
4. **URL params**（路由状态）：sessionId、projectId、mode

## Context 使用模式
```typescript
// 定义
const MyContext = createContext<ContextValue | null>(null);

// Provider
export function MyProvider({ children }: { children: React.ReactNode }) {
  const [state, setState] = useState(initialValue);
  return <MyContext.Provider value={{ state, setState }}>{children}</MyContext.Provider>;
}

// Hook（必须包含 null check）
export function useMy(): ContextValue {
  const context = useContext(MyContext);
  if (!context) throw new Error('useMy must be used within MyProvider');
  return context;
}
```

## localStorage 存储
- 所有 key 必须通过 `scopedKey()` 添加 workspace 前缀，支持多工作区隔离
- 读取时检查 `typeof window === 'undefined'` 防止 SSR 错误
- 写入使用 debounce（500ms）避免频繁 IO
- 数据结构包含 `version` 字段以便未来迁移

## 数据获取模式
- 短请求：`fetch()` + `useState` + `useEffect`
- 长轮询：自定义 hook（如 `useAgentStatus`）内 `setInterval`
- 流式数据：SSE（`text/event-stream`） + `ReadableStream` reader
- CLI 交互：`useCliChat` hook 管理双向流

## SSR 安全
- `localStorage`/`sessionStorage` 访问必须在 `useEffect` 或条件判断 `typeof window !== 'undefined'` 中
- 所有使用浏览器 API 的组件必须标记 `'use client'`
