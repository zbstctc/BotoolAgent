# 测试用例规范

## 测试命名
- 使用 `describe` 描述测试套件（模块/功能名）
- 使用 `it` 或 `test` 描述具体行为（"should ..."）
- 文件命名：`{feature}.spec.ts`

## 测试覆盖要求
- 单元测试覆盖率 > 80%
- 每个 API 端点至少一个正常路径 + 一个错误路径测试
- 关键用户流程必须有 E2E 测试

## E2E 测试（Playwright）
- 配置文件：`playwright.config.ts`
- 测试目录：`tests/`
- 每个 Stage 的核心流程需覆盖：
  - Stage 1：模式选择 → 问答 → PRD 生成 → 保存
  - Stage 2：规范选择 → PRD 转 JSON
  - Stage 3：Agent 启动 → 状态监控 → Agent 停止
  - Stage 5：代码审查 → 合并

## API 测试模式
```typescript
describe('POST /api/prd/save', () => {
  it('should save PRD content and return id', async () => {
    const response = await fetch('/api/prd/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: '# PRD: Test' }),
    });
    expect(response.ok).toBe(true);
    const data = await response.json();
    expect(data.id).toBeDefined();
  });

  it('should return 400 for empty content', async () => {
    const response = await fetch('/api/prd/save', {
      method: 'POST',
      body: JSON.stringify({ content: '' }),
    });
    expect(response.status).toBe(400);
  });
});
```

## 测试数据
- 使用固定的测试数据，不依赖外部服务
- 测试 PRD 内容使用 `# PRD: Test Project` 格式
- 清理：测试完成后删除测试生成的文件

## 断言规范
- 优先使用 Playwright 内置断言（`expect(page.locator(...)).toBeVisible()`）
- 网络请求断言：`page.waitForResponse(url => url.includes('/api/...'))`
- 避免 `sleep`/固定等待，使用条件等待

## TypeScript 规范
- 测试文件使用 TypeScript（`.spec.ts`），不使用 `.spec.js`
- 测试中的类型导入：`import type { ... } from '@/lib/tool-types'`
- Typecheck 必须通过：`npx tsc --noEmit`
