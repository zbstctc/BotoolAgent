---
name: botoolagent-pyramidprd
description: "金字塔式 PRD 问答生成器。通过 5 层递进式问答（含 ASCII 可视化确认门控）收集需求，生成多维度高颗粒度 PRD 文档。触发词：pyramid prd, 金字塔问答, 层级问答"
user-invocable: true
---

# BotoolAgent 金字塔 PRD 生成器

通过 5 层递进式问答（含 ASCII 可视化确认门控），系统性地收集需求并生成**多维度、高颗粒度** PRD 文档。

**启动提示:** "Using BotoolAgent:PyramidPRD to collect requirements through structured Q&A."

---

## 重要：所有内容必须使用中文

所有问题、选项、描述、反馈都必须使用中文。

---

## 金字塔结构概述

```
评估复杂度 → 确定问题数量 → 选择模式
    ↓
L1: 核心识别 - 理解需求本质
    ↓
代码库扫描（增强版：技术栈 + 数据库 + 组件接口 + API 签名）
    ↓
L2: 领域分支 - 按维度深入（融合扫描结果）+ 数据模型 + UI 层次
    ↓
L3: 细节深入 - 实现细节 + 状态流转 + 业务规则 + 组件交互
    ↓
L4: 边界确认 - 范围边界 + 文件命名约定 + 现有代码修改范围
    ↓
L5: 确认门控 - ASCII 多维度可视化确认（架构/数据/UI/规则/计划）
    ↓
生成多维度 PRD 文档（§1-§8，含 ASCII 图 + 安全检查自动注入）
```

---

## 动态复杂度评估

**收到需求描述后，首先评估复杂度，决定每层问多少问题。**

### 复杂度判断标准

| 复杂度 | 特征 | 每层问题数 | 示例 |
|--------|------|-----------|------|
| **简单** | 单一功能、单一用户、无后端 | 3-4 个 | "做个计数器"、"添加深色模式" |
| **中等** | 多个功能点、需要后端、有数据存储 | 5-7 个 | "用户登录功能"、"数据导出" |
| **复杂** | 多角色、多模块、复杂业务逻辑 | 8-12 个 | "用户管理系统"、"订单流程" |

### 复杂度信号

**简单需求信号：**
- 描述少于 10 个字
- 只提到一个功能点
- 明确说"简单"、"基础"、"MVP"

**中等需求信号：**
- 涉及前后端
- 需要数据持久化
- 有 2-3 个功能点

**复杂需求信号：**
- 涉及多个用户角色
- 有复杂的业务流程
- 需要与多个系统集成
- 描述中有"系统"、"平台"、"管理"等词

### 在 metadata 中标注复杂度

```json
{
  "metadata": {
    "source": "pyramidprd",
    "level": 1,
    "complexity": "medium",
    "questionsPerLevel": "5-7"
  }
}
```

---

## 核心规则：使用 AskUserQuestion 批量提问

**每次调用 AskUserQuestion 时，必须在 metadata 中包含 level 信息！**

```json
{
  "questions": [...],
  "metadata": {
    "source": "pyramidprd",
    "level": 1,
    "levelName": "L1: 核心识别",
    "progress": "1/5",
    "totalLevels": 5,
    "codebaseScanned": false
  }
}
```

**问题格式要求：**
- **必须根据复杂度决定问题数量**（见上方复杂度评估）
- 每个问题第一行标注层级：`【L1: 核心识别】问题内容`
- options 要有 label 和 description
- **重要：不要固定只问 3-4 个问题，复杂需求必须问 8-12 个！**

---

## 执行流程

### Phase 0: 模式选择（AI 推荐 + 用户决定）

**目标：** 根据用户的初始需求描述，AI 评估复杂度并推荐模式，但最终由用户选择。

**注意：** 如果用户的消息中已包含 `[模式:快速修复]`、`[模式:功能开发]`、`[模式:导入]` 等模式标记（由 Viewer 前端自动添加），则跳过模式选择，直接按指定模式进入对应流程。

**步骤 1：接收用户需求描述**

用户提供初始需求描述后，在内部进行复杂度评估（不展示给用户）：

| 分析维度 | 权重 | Quick Fix | Feature Build | Full Planning |
|----------|------|-----------|---------------|---------------|
| 涉及文件数（预估） | 30% | 1-2个 | 3-8个 | 8+个 |
| 是否有数据模型变更 | 25% | 无 | 可能有 | 一定有 |
| 是否需要新建模块/页面 | 20% | 否 | 可能 | 是 |
| 是否涉及多个系统层 | 15% | 1层 | 2-3层 | 全栈 |
| 描述复杂度（字数/概念） | 10% | <50字 | 50-200字 | 200+字 |

**步骤 2：使用 AskUserQuestion 呈现选择**

```json
{
  "questions": [
    {
      "question": "我分析了你的需求，推荐使用以下模式。请选择：",
      "header": "模式选择",
      "options": [
        { "label": "快速修复 (~2分钟)", "description": "适合改 bug、调样式、小调整。流程：描述需求->确认任务->自动执行" },
        { "label": "功能开发 (~10-15分钟) 推荐", "description": "适合新功能、新页面、多文件变更。流程：核心问答->任务规划->确认->自动执行" },
        { "label": "完整规划 (~30-45分钟)", "description": "适合架构级变更、新模块、复杂系统。流程：5层金字塔问答->富化规格->确认->自动执行" },
        { "label": "PRD 导入 (~15-20分钟)", "description": "你已有现成的需求文档，系统将分析→补充→转换为标准格式→拆解为开发任务" }
      ],
      "multiSelect": false
    }
  ]
}
```

注意：「推荐」标记应根据 AI 评估结果放在对应的选项上。

**步骤 3：根据选择进入不同流程**

- **快速修复** -> 进入 Phase 1-Quick（简化流程）
- **功能开发** -> 进入 Phase 1（跳过 L2、L3，只走 L1 + L4 + 确认）
- **完整规划** -> 进入 Phase 1（完整 L1->L5 流程，即当前默认流程）
- **PRD 导入** -> 进入 Phase T1-Transform（Transform 流程，见下文）

---

### Phase 1-Quick: 快速修复流程

**适用：** 用户选择了快速修复模式

1. 用户已提供初始描述
2. 执行代码库扫描（如果有代码库）
3. AI 自动生成 1-3 个 DT 任务
4. 使用 AskUserQuestion 确认任务列表
5. 自动检测 tasks 目录：`TASKS_DIR="$([ -d BotoolAgent/tasks ] && echo BotoolAgent/tasks || echo tasks)"`
6. 生成极简 PRD.md 到 `$TASKS_DIR/prd-[feature-name].md`（只含 § 1 项目概述 + § 7 开发计划，无 § 2-6）
7. 跳过 Stage 2 的规则选择（constitution 可选）
8. 生成 prd.json 到项目根目录（含 prdFile 指向 `$TASKS_DIR/prd-xxx.md`、每个 DT 有 prdSection）
8. 执行安全关键词扫描（仅对高风险关键词：认证/支付）

---

### Phase 1: 接收需求描述并评估复杂度

用户会提供一句话需求描述，例如：
- `/botoolagent-pyramidprd 做一个用户登录功能`
- `/botoolagent-pyramidprd 添加数据导出功能`

**收到后：**
1. **快速评估复杂度**（内部判断，不输出给用户）
2. **确定问题数量策略**
3. **立即开始 L1 提问**

**模式影响问答流程：**
- **功能开发模式** -> 只走 L1 核心识别 + L4 边界确认 + L5 确认门控（跳过 L2 领域分支和 L3 细节深入）
- **完整规划模式** -> 完整 L1 -> L2 -> L3 -> L4 -> L5 流程（当前默认行为）

**复杂度决定问题深度：**
- 简单需求 -> 每层 3-4 个问题，快速完成
- 中等需求 -> 每层 5-7 个问题，适度深入
- 复杂需求 -> 每层 8-12 个问题，全面覆盖

---

### Phase 2: L1 核心识别

**目标：** 理解需求的本质和范围

**必问话题：**
1. **问题域** - 这个需求涉及哪些领域？
2. **目标用户** - 谁会使用这个功能？
3. **核心价值** - 解决什么痛点？
4. **规模预期** - MVP 还是完整功能？

（问题示例与格式同之前，此处省略以避免冗余。保持所有 AskUserQuestion 调用必须带 metadata。）

**L1 完成后：**
- 根据答案确定激活哪些 L2 维度（frontend, backend, ux, architecture）
- 简短总结收集的信息
- **进入代码库扫描阶段**（如果有代码库）
- 扫描完成后进入 L2

---

### Phase 2.5: 代码库感知扫描（L1→L2 之间）（增强版）

**目标：** 扫描当前项目代码库，识别技术栈、架构模式、现有组件和数据模型，为后续问答和 PRD 生成提供精准上下文。

**触发条件：** L1 完成后自动判断是否有代码库。

#### 判断是否有代码库

使用 Glob 工具检查当前工作目录是否有项目文件：
- 检查 `package.json`、`tsconfig.json`、`Cargo.toml`、`go.mod`、`requirements.txt`、`pom.xml` 等
- 如果没有任何项目文件 → **跳过扫描**，在 metadata 中标记 `codebaseScanned: false`，直接进入 L2
- 如果有项目文件 → **执行扫描**

#### 扫描步骤（有代码库时执行）

**步骤 1：技术栈检测**（不变）
- 使用 Read 读取 `package.json`（检查 dependencies/devDependencies）
- 识别框架（React、Next.js、Vue、Express、Django 等）
- 识别语言（TypeScript、JavaScript、Python、Go 等）
- 识别构建工具（Vite、Webpack、Turbo 等）

**步骤 2：目录结构分析**（不变）
- 使用 Glob 扫描顶层目录结构（`*`、`src/*`、`app/*`）
- 识别项目架构模式（monorepo、标准 src 结构、Next.js App Router 等）
- 记录关键目录（components、pages/app、api、lib、utils 等）

**步骤 3：现有组件/路由/API 识别**（不变）
- 使用 Glob 扫描 `src/components/**/*.{tsx,jsx,vue}` 识别现有组件
- 使用 Glob 扫描 `src/app/**/page.{tsx,jsx}` 或 `pages/**/*.{tsx,jsx}` 识别路由
- 使用 Glob 扫描 `src/app/api/**/*.{ts,js}` 或 `api/**/*.{ts,js}` 识别 API 接口
- 记录关键组件名称和路由路径

**步骤 4：数据模型分析**（不变）
- 使用 Grep 搜索 `schema.prisma`、`models.py`、数据库模型定义
- 使用 Grep 搜索类型定义文件（`types.ts`、`interfaces.ts`）
- 识别核心数据模型和关系

**步骤 5：数据库 Schema 扫描**（NEW）
- 使用 Glob 搜索 `**/*.sql`、`**/migrations/**`、`**/schema.prisma`
- 读取现有 SQL 建表语句，提取表名、字段、约束
- 识别哪些表已存在、哪些有 RLS 策略
- 这些信息将用于 PRD § 2（当前状态）和 § 4（数据设计）

**步骤 6：UI 组件接口扫描**（NEW）
- 使用 Grep 搜索 `interface.*Props`、`type.*Props` 提取组件 Props 定义
- 识别可复用的组件及其接口签名
- 这些信息将用于 PRD § 5（UI 设计，标记可复用组件）

**步骤 7：API 签名扫描**（NEW）
- 使用 Grep 搜索 `export.*GET`、`export.*POST`、`export.*PUT`、`export.*DELETE`
- 识别已有 API 端点的方法签名
- 这些信息将用于 PRD § 2（当前状态）

**步骤 8：业务逻辑扫描**（NEW）
- 读取关键 `services/`、`lib/` 文件的 export 列表
- 识别已有的业务逻辑函数和服务
- 这些信息将用于 PRD § 2（当前状态）

#### 扫描结果双重用途

扫描结果用于两个目的：

**1. 内化到后续问题中（不变）：**
- L2 问题中预设当前项目的技术栈
- 组件选项中包含已有组件名称
- API 类型根据项目现有模式预设

**2. 作为 PRD 内容数据源（NEW）：**
- § 2 当前状态：已有能力表格 + 缺口分析
- § 4 数据设计：已有 Schema 作为基准
- § 5 UI 设计：已有组件标记为可复用
- § 8 附录：代码文件索引的基础数据

#### 步骤 9：生成/更新 PROJECT.md（不变）

在代码库扫描完成后，自动生成或更新项目根目录的 `PROJECT.md` 文件。逻辑不变。

#### 无代码库时的降级处理（不变）

如果判断没有代码库（新项目）：
- 在 metadata 中标记 `codebaseScanned: false`
- 跳过扫描，直接进入 L2
- PRD § 2 当前状态将显示为"新项目，无现有代码库"

#### 扫描耗时提示（不变）

扫描前向用户发送简短提示：
> "正在分析项目代码库，以便为您提供更精准的问题..."

扫描完成后简短总结：
> "已识别项目技术栈：[Next.js + TypeScript + Prisma]，将基于现有架构生成更精准的问题。"

---

### Phase 3: L2 领域分支（增强版）

**目标：** 按领域深入探索具体需求。**如果代码库扫描已完成（codebaseScanned: true），必须在问题选项中融入扫描发现的信息。**

**融合扫描结果的规则：**
- 技术栈选项中预设当前项目的技术栈作为推荐选项
- 组件选项中包含已有组件名称（如「复用现有 DataTable 组件」）
- API 类型和数据存储选项根据扫描结果预设
- 如果 `codebaseScanned: false`，使用通用选项

**维度定义：**

#### frontend（前端）
- 页面结构（单页/多页/仪表盘）
- 核心组件（表单/列表/图表）
- 响应式需求
- 交互方式

#### backend（后端）
- API 类型
- 数据模型
- 认证方式
- 存储需求

#### ux（用户体验）
- 用户旅程
- 核心流程
- 错误处理
- 反馈机制

#### architecture（技术架构）
- 技术栈
- 模块划分
- 部署方式

**新增话题（功能开发 + 完整规划模式）：**

#### dataModel（数据模型）— NEW
- 是否需要新建数据库表？
- 核心表的关键字段有哪些？
- 与现有表的关系（外键/引用）？
- 是否有约束或特殊规则（唯一/枚举/软删除）？

#### uiStructure（UI 层次）— NEW
- 需要几个新页面？列出页面名称和路由
- 复用哪些已有组件？需要新建哪些组件？
- 需要哪些弹窗/对话框？
- 关键页面的大致布局（左右分栏/上下结构/Tab 切换）？

**根据 L1 答案选择激活的维度，为每个维度生成 2-4 个问题。**

---

### Phase 4: L3 细节深入（增强版）

**目标：** 根据 L2 答案，深入实现细节

**动态话题（根据 L2 答案激活）：**

#### 如果有表单
- 验证规则
- 错误提示方式
- 提交流程

#### 如果有列表
- 分页方式
- 排序过滤
- 空状态

#### 如果有 API
- 错误处理
- 权限控制

#### 如果有数据模型
- 模型关系
- 字段定义

**新增话题（仅完整规划模式）：**

#### 状态流转 — NEW
- 核心实体有几种状态？（如 draft/published/archived）
- 状态之间如何转换？谁能触发转换？
- 是否有不可逆的状态变更？
- 状态变更时是否有副作用（如通知、级联更新）？

#### 业务规则 — NEW
- 有哪些核心业务规则？（如"版本号单调递增"、"同一分类下不可重复指派"）
- 删除操作是否有级联影响？如何处理？
- 是否有需要弹窗确认的危险操作？
- 边界情况有哪些？

#### 组件交互 — NEW
- 弹窗确认流程是怎样的？（如创建/删除确认）
- 下拉选择的选项来源？（静态列表/API 动态加载）
- 是否有拖拽排序、批量操作等复杂交互？

---

### Phase 5: L4 边界确认（增强版）

**目标：** 确认范围边界，防止范围蔓延

**必问话题：**
1. **集成点** - 需要修改哪些现有代码？
2. **排除范围** - 哪些功能明确不做？
3. **非功能需求** - 性能/安全要求？
4. **MVP 边界** - 哪些可以推迟？

**新增话题（功能开发 + 完整规划模式）：**

#### 文件命名约定 — NEW
- API 路径模式（如 `/api/[resource]/route.ts`）？
- 组件文件命名约定（如 PascalCase）？
- 是否有现有的目录结构约定需要遵循？

#### 现有代码修改范围 — NEW
- 哪些现有文件会被修改（而非新建）？
- 是否需要修改数据库（新建表/修改现有表）？
- 是否需要修改现有的类型定义？

---

### Phase 6: L5 确认门控（ASCII 多维度可视化）

**目标：** L4 完成后，在生成 PRD 前，向用户展示 **ASCII 可视化的多维度确认摘要**，确保需求理解一致。

**触发条件：** L4 所有问题回答完毕后自动进入。

#### 按模式裁剪 L5 步骤

8 个维度分 **2 轮 Tabs** 展示，每轮 4 个 Tab，用户可左右切换快速审阅。每个 Tab 只聚焦 **一个维度**。

| 维度 | Tab | 快速修复 | 功能开发 | 完整规划 |
|------|-----|---------|---------|---------|
| 项目概述 | 第 1 轮 Tab 1 | 跳过 | 展示 | 展示 |
| 核心架构 | 第 1 轮 Tab 2 | 跳过 | 展示 | 展示 |
| 用户角色 | 第 1 轮 Tab 3 | 跳过 | 展示 | 展示 |
| 核心工作流 | 第 1 轮 Tab 4 | 跳过 | 展示 | 展示 |
| 数据模型 | 第 2 轮 Tab 1 | 跳过 | 跳过 | 展示 |
| 关键 UI | 第 2 轮 Tab 2 | 跳过 | 跳过 | 展示（仅有前端时） |
| 业务规则 | 第 2 轮 Tab 3 | 跳过 | 跳过 | 展示 |
| 总确认 | 第 2 轮 Tab 4 | 跳过 | 展示 | 展示 |

**快速修复模式：** 跳过 L5，直接生成。

**功能开发模式：** 只展示第 1 轮（4 Tabs）+ 第 2 轮 Tab 4（总确认），跳过数据模型/关键 UI/业务规则。

**设计原则：**
- 每个 Tab 的 ASCII 可视化内容必须聚焦单一维度，禁止混合多个维度
- 使用 AskUserQuestion 的多问题能力（最多 4 个 questions），每个 question 作为一个 Tab
- 用户可以在 Tabs 之间左右切换，快速审阅所有维度，一次性提交确认

---

#### 第 1 轮：架构与角色确认（4 Tabs 同时展示）

**一次 AskUserQuestion 调用，包含 4 个 questions（= 4 个 Tabs）。** 用户可切换 Tab 逐个审阅。

**Tab 1 — 项目概述** ASCII 模板：
```
┌─────────────────────────────────────────┐
│  [项目名称] v[版本]                     │
│  [一句话定位描述]                        │
├─────────────────────────────────────────┤
│                                         │
│  背景: [为什么要做这个项目/功能]         │
│                                         │
│  目标:                                  │
│    1. [核心目标1]                        │
│    2. [核心目标2]                        │
│    3. [核心目标3]                        │
│                                         │
│  技术栈: [框架] + [语言] + [数据库]      │
│          + [状态管理] + [其他]           │
│                                         │
│  模式: [快速修复 / 功能开发 / 完整规划]   │
└─────────────────────────────────────────┘
```

**Tab 2 — 核心架构** ASCII 模板：
```
───────── 核心实体关系 ─────────

   [实体A]
      │
      ├──── 1:N ──── [实体B]
      │                  │
      │                  └── 1:N ──── [实体C]
      │
      └──── M:N ──── [实体D]

───────── 实体说明 ─────────
┌──────────────┬──────────────────────────┐
│ 实体         │ 职责                     │
├──────────────┼──────────────────────────┤
│ [实体A]      │ [一句话说明其核心职责]    │
│ [实体B]      │ [一句话说明其核心职责]    │
│ [实体C]      │ [一句话说明其核心职责]    │
│ [实体D]      │ [一句话说明其核心职责]    │
└──────────────┴──────────────────────────┘
```

**Tab 3 — 用户角色** ASCII 模板：
```
───────── 角色定义 ─────────

┌──────────────────┐     ┌──────────────────┐
│  [角色A]         │     │  [角色B]         │
│                  │     │                  │
│  权限:           │     │  权限:           │
│  - [权限1]       │     │  - [权限1]       │
│  - [权限2]       │     │                  │
│  - [权限3]       │     │  入口:           │
│                  │     │  [路由/页面]      │
│  入口:           │     └──────────────────┘
│  [路由/页面]      │
└──────────────────┘

───────── 权限矩阵 ─────────
┌──────────┬────────┬────────┬────────┐
│ 操作     │ 角色A  │ 角色B  │ 角色C  │
├──────────┼────────┼────────┼────────┤
│ [操作1]  │  [权限] │  [权限] │  [权限] │
│ [操作2]  │  [权限] │  [权限] │  [权限] │
│ [操作3]  │  [权限] │  [权限] │  [权限] │
└──────────┴────────┴────────┴────────┘
```

**Tab 4 — 核心工作流** ASCII 模板：
```
───────── 阶段流转 ─────────

Phase 1 ──▶ Phase 2 ──▶ Phase 3 ──▶ Phase 4
[名称]      [名称]      [名称]      [名称]
(P0)        (P0)        (P1)        (P2)

───────── 阶段详情 ─────────
┌─────────┬──────────────────┬──────┐
│ Phase   │ 内容             │ 优先级│
├─────────┼──────────────────┼──────┤
│ Phase 1 │ [一句话描述]      │ P0   │
│ Phase 2 │ [一句话描述]      │ P0   │
│ Phase 3 │ [一句话描述]      │ P1   │
│ Phase 4 │ [一句话描述]      │ P2   │
└─────────┴──────────────────┴──────┘

───────── 依赖关系 ─────────
Phase 1 → 全部（基础设施）
Phase 2 + 3 → Phase 4
Phase 3 可并行
```

**AskUserQuestion 调用（第 1 轮）：**
```json
{
  "questions": [
    {
      "question": "【L5 第 1 轮 — Tab 1/4】\n\n[项目概述 ASCII 内容]\n\n以上项目概述是否准确？",
      "header": "项目概述",
      "options": [
        { "label": "准确", "description": "项目定位、目标和技术栈描述正确" },
        { "label": "需要修改", "description": "有不准确的地方，我会说明" }
      ],
      "multiSelect": false
    },
    {
      "question": "【L5 第 1 轮 — Tab 2/4】\n\n[核心架构 ASCII 内容]\n\n以上核心架构是否准确？",
      "header": "核心架构",
      "options": [
        { "label": "准确", "description": "实体关系和职责描述正确" },
        { "label": "需要修改", "description": "有不准确的地方，我会说明" }
      ],
      "multiSelect": false
    },
    {
      "question": "【L5 第 1 轮 — Tab 3/4】\n\n[用户角色 ASCII 内容]\n\n以上用户角色和权限是否准确？",
      "header": "用户角色",
      "options": [
        { "label": "准确", "description": "角色划分和权限描述正确" },
        { "label": "需要修改", "description": "有不准确的地方，我会说明" }
      ],
      "multiSelect": false
    },
    {
      "question": "【L5 第 1 轮 — Tab 4/4】\n\n[核心工作流 ASCII 内容]\n\n以上工作流阶段和依赖关系是否准确？",
      "header": "核心工作流",
      "options": [
        { "label": "准确", "description": "阶段划分、优先级和依赖描述正确" },
        { "label": "需要修改", "description": "有不准确的地方，我会说明" }
      ],
      "multiSelect": false
    }
  ],
  "metadata": {
    "source": "pyramidprd",
    "level": 5,
    "levelName": "L5: 确认门控",
    "round": "1/2",
    "roundName": "架构与角色确认",
    "tabs": ["项目概述", "核心架构", "用户角色", "核心工作流"]
  }
}
```

**处理修改请求：** 如果任何 Tab 被选择了「需要修改」，用户会通过 "Other" 选项说明修改内容。根据反馈调整对应维度后，**仅重新展示需要修改的 Tab**（使用单独的 AskUserQuestion，questions 数量 = 需修改的 Tab 数量）。

**功能开发模式：** 第 1 轮全部展示（4 Tabs），与完整规划一致。

---

#### 第 2 轮：数据与实现确认（4 Tabs 同时展示）

**一次 AskUserQuestion 调用，包含 4 个 questions（= 4 个 Tabs）。**

**Tab 1 — 数据模型** ASCII 模板：
```
───────── 数据表 ─────────
┌──────────────┬──────────────────────┬───────────┐
│ 模型         │ 关键字段              │ 状态      │
├──────────────┼──────────────────────┼───────────┤
│ [table_a]    │ id, name, type, ...  │ 新建      │
│ [table_b]    │ id, a_id, value, ... │ 新建      │
│ [existing]   │ id, ...              │ 修改(+col)│
└──────────────┴──────────────────────┴───────────┘

───────── 表间关系 ─────────
[table_a] ──1:N──▶ [table_b]
[table_a] ──N:1──▶ [existing]

───────── 索引建议 ─────────
[table_b].a_id  → 外键索引
[table_a].type  → 查询索引
```

**Tab 2 — 关键 UI（仅有前端时）** ASCII 模板：

**每个关键页面/弹窗单独展示。** 如果页面较多，在 question 文本中依次排列所有页面的 ASCII 线框：

```
───────── 页面 1: [页面名] ─────────
┌─────────────────────────────────────────┐
│  [Header / Nav]                         │
│  ┌──────────┬──────────────────────┐   │
│  │ Sidebar  │ Main Content         │   │
│  │          │                      │   │
│  │ - Item1  │ ┌──────────────────┐ │   │
│  │ - Item2  │ │  Data Table      │ │   │
│  │ - Item3  │ │  or Form         │ │   │
│  │          │ └──────────────────┘ │   │
│  └──────────┴──────────────────────┘   │
└─────────────────────────────────────────┘

───────── 页面 2: [页面名] ─────────
┌─────────────────────────────────────────┐
│  [不同布局的页面]                        │
│  ...                                    │
└─────────────────────────────────────────┘

───────── 弹窗: [弹窗名] ─────────
┌─────────────────────────────────┐
│  [弹窗标题]                [x]  │
│  ─────────────────────────────  │
│  [表单字段 / 选项列表]          │
│                                 │
│              [取消]  [确认]      │
└─────────────────────────────────┘
```

**Tab 3 — 业务规则** ASCII 模板：
```
───────── 业务规则 ─────────
┌─────┬──────────────────────────┬──────────────┐
│ ID  │ 规则                     │ 影响范围     │
├─────┼──────────────────────────┼──────────────┤
│ BR1 │ [规则描述1]              │ Phase 1      │
│ BR2 │ [规则描述2]              │ Phase 2,3    │
│ BR3 │ [规则描述3]              │ Phase 3      │
└─────┴──────────────────────────┴──────────────┘

───────── 决策树: [场景名] ─────────
用户操作
├── 条件A?
│   ├── 是 → 执行动作X
│   └── 否 → 执行动作Y
└── 条件B?
    └── 是 → 弹窗警告 → 用户确认 → 执行
```

**Tab 4 — 总确认（开发计划 + 风险）** ASCII 模板：

**此 Tab 不重复前面已确认的内容**，只聚焦执行层面：

```
───────── 开发计划 ─────────
Phase 1 ──▶ Phase 2 ──▶ Phase 3
[名称]      [名称]      [名称]
DT数: N     DT数: M     DT数: K
(P0)        (P0)        (P1)

依赖: Phase 1 是 Phase 2/3 的前置

───────── 风险评估 ─────────
HIGH:   [风险项]
MEDIUM: [风险项]
LOW:    [风险项]

───────── 安全检查预告 ─────────
将为 DT-001、DT-003 自动注入 N 项安全验收标准

───────── 复杂度估计 ─────────
[简单/中等/复杂]，预计 N 个开发任务，分 M 个 Phase
```

**AskUserQuestion 调用（第 2 轮）：**
```json
{
  "questions": [
    {
      "question": "【L5 第 2 轮 — Tab 1/4】\n\n[数据模型 ASCII 内容]\n\n以上数据模型是否准确？",
      "header": "数据模型",
      "options": [
        { "label": "准确", "description": "数据表、字段和关系描述正确" },
        { "label": "需要修改", "description": "有不准确的地方，我会说明" }
      ],
      "multiSelect": false
    },
    {
      "question": "【L5 第 2 轮 — Tab 2/4】\n\n[关键 UI ASCII 内容]\n\n以上 UI 布局是否准确？",
      "header": "关键 UI",
      "options": [
        { "label": "准确", "description": "页面布局和交互流程描述正确" },
        { "label": "需要修改", "description": "有不准确的地方，我会说明" }
      ],
      "multiSelect": false
    },
    {
      "question": "【L5 第 2 轮 — Tab 3/4】\n\n[业务规则 ASCII 内容]\n\n以上业务规则是否准确？",
      "header": "业务规则",
      "options": [
        { "label": "准确", "description": "业务规则和决策逻辑描述正确" },
        { "label": "需要修改", "description": "有不准确的地方，我会说明" }
      ],
      "multiSelect": false
    },
    {
      "question": "【L5 第 2 轮 — Tab 4/4】\n\n[总确认 ASCII 内容]\n\n以上开发计划和风险评估是否准确？确认后将生成完整 PRD 文档。",
      "header": "总确认",
      "options": [
        { "label": "确认并生成 PRD", "description": "所有信息准确，请生成完整 PRD 文档" },
        { "label": "需要修改", "description": "部分信息不准确，需要调整" }
      ],
      "multiSelect": false
    }
  ],
  "metadata": {
    "source": "pyramidprd",
    "level": 5,
    "levelName": "L5: 确认门控",
    "round": "2/2",
    "roundName": "数据与实现确认",
    "tabs": ["数据模型", "关键 UI", "业务规则", "总确认"],
    "confirmationSummary": { ... }
  }
}
```

**功能开发模式：** 第 2 轮只展示 Tab 4（总确认），使用单独的 AskUserQuestion（1 个 question）。

**处理修改请求：** 同第 1 轮逻辑 — 仅重新展示需要修改的 Tab。

**选择「确认并生成 PRD」（第 2 轮 Tab 4）：** 进入 Phase 7 生成 PRD。

**选择「需要修改」：** 使用 AskUserQuestion 询问修改范围（同之前的逻辑：修改功能范围/技术方案/风险评估/移除安全项/返回重新提问）。

---

### Phase 7: 生成多维度 PRD（模板重写）

**L5 确认门控通过后，根据收集的所有信息和代码库扫描结果，生成多维度、高颗粒度的 PRD 文档。**

**输出路径（兼容 portable 模式）：**
```bash
TASKS_DIR="$([ -d BotoolAgent/tasks ] && echo BotoolAgent/tasks || echo tasks)"
# PRD 写入: $TASKS_DIR/prd-[feature-name].md
# prd.json 双写: $TASKS_DIR/prd-[feature-name].json + 项目根目录 ./prd.json
# registry 更新: $TASKS_DIR/registry.json
```

#### 复杂度裁剪规则

| PRD 节 | 快速修复 | 功能开发 | 完整规划 |
|--------|---------|---------|---------|
| § 1. 项目概述 | 2-3 句 | 1 段 | 完整（背景/目标/指标） |
| § 2. 当前状态 | 跳过 | 简要表格 | 完整（含 ASCII 缺口分析） |
| § 3. 架构设计 | 跳过 | 概要（1 个 ASCII） | 完整（多 ASCII：概念/角色/工作流/状态机） |
| § 4. 数据设计 | 跳过 | Schema 表格 | 完整（SQL CREATE + ER 图 + 约束） |
| § 5. UI 设计 | 跳过 | 组件清单表格 | 完整（ASCII 布局 + 弹窗 + Props 接口） |
| § 6. 业务规则 | 跳过 | 简要表格 | 完整（分领域规则表 + 决策树 ASCII） |
| § 7. 开发计划 | 1-3 个 DT | Phase 列表 + DT | 完整（Phase 依赖图 + DT 含文件路径） |
| § 8. 附录 | 跳过 | 文件索引 | 完整（文件索引 + 风险 + 测试 + 非目标 + 安全） |

#### PRD 模板（完整规划模式）

```markdown
# PRD: [功能名称]

## 1. 项目概述

### 1.1 背景与动机
[基于 L1 答案描述背景和要解决的问题]

### 1.2 核心目标
- [目标 1：具体可衡量]
- [目标 2：具体可衡量]

### 1.3 成功指标
- [指标 1]
- [指标 2]

## 2. 当前状态

### 2.1 已有能力

| 模块 | 状态 | 说明 |
|------|------|------|
| [模块名] | ✅ 已实现 | [描述] |
| [模块名] | ⚠️ 部分实现 | [描述 + 缺失部分] |
| [模块名] | ❌ 未实现 | [描述] |

### 2.2 缺口分析

[基于代码库扫描，描述代码存在但功能不可用的部分，或完全缺失的部分]

## 3. 架构设计

### 3.1 核心概念

```
[ASCII 核心概念关系图 — 展示主要实体及其关系]
```

### 3.2 用户角色

```
[ASCII 角色权限图 — 展示不同角色的权限和可访问路由]
```

### 3.3 核心工作流

```
[ASCII 多 Phase 流程图 — 展示用户操作的完整步骤]
```

### 3.4 状态机

```
[ASCII 状态转换图 — 如有状态流转需求（如 draft → published）]
```

## 4. 数据设计

### 4.1 数据模型概览

| 模型 | 用途 | 关键字段 | 状态 |
|------|------|---------|------|
| [表名] | [用途] | [字段列表] | 新建/修改/已有 |

### 4.2 Schema 定义

```sql
-- [表名]: [用途]
CREATE TABLE [表名] (
  id            SERIAL PRIMARY KEY,
  [字段名]      [类型] [约束],  -- [说明]
  ...
  created_at    TIMESTAMPTZ DEFAULT NOW()
);
```

### 4.3 模型关系

```
[ASCII ER 图 — 展示表之间的关系]
```

### 4.4 约束与规则

| 约束 | 说明 |
|------|------|
| [约束名/索引] | [描述] |

## 5. UI 设计

### 5.1 页面清单

| 页面 | 路由 | 说明 | 状态 |
|------|------|------|------|
| [页面名] | `/path/to/page` | [描述] | 新建/已有 |

### 5.2 组件清单

| 组件 | Props 接口 | 复用位置 | 状态 |
|------|-----------|---------|------|
| [组件名] | `{ prop1: type, prop2: type }` | [页面列表] | 新建/已有/提取 |

### 5.3 关键页面布局

```
[ASCII 页面布局 — 展示核心页面的组件排列]
```

### 5.4 关键弹窗/交互

```
[ASCII 弹窗布局 — 展示核心弹窗的字段和按钮]
```

## 6. 业务规则

### 6.1 [领域名] 规则

| ID | 规则 | 说明 | 影响任务 |
|----|------|------|---------|
| BR-001 | [规则名] | [描述] | DT-XXX |

### 6.2 决策树

```
[ASCII 决策树 — 展示复杂业务逻辑的分支判断]
```

## 7. 开发计划

### 7.0 Phase 依赖图

```
Phase 1 ──▶ Phase 2 ──▶ Phase 3
[名称]     [名称]     [名称]
(P0)       (P0)       (P1)

依赖关系:
Phase 1 是所有后续 Phase 的前置
Phase 2, Phase 3 可并行
```

### 7.1 Phase 1: [名称] (P0)

> **前置**: 无
> **产出**: [具体产出描述]
> **对应设计**: Section 3.3, 4.2

- [ ] DT-001: [任务描述] (`API: /api/xxx`, `文件: src/xxx`)
- [ ] DT-002: [任务描述] (`组件: <Xxx>`, `文件: src/components/xxx`)
- [ ] DT-003: [任务描述]

### 7.2 Phase 2: [名称] (P1)

> **前置**: Phase 1
> **产出**: [具体产出描述]
> **对应设计**: Section 5.3, 5.4

- [ ] DT-004: [任务描述]
- [ ] DT-005: [任务描述]

[... 更多 Phase ...]

## 8. 附录

### A. 代码文件索引

| 文件路径 | 状态 | Phase | 任务 |
|---------|------|-------|------|
| `src/components/xxx.tsx` | 待开发 | Phase 2 | DT-004 |
| `src/api/xxx/route.ts` | 待开发 | Phase 1 | DT-001 |
| `src/lib/auth.ts` | ✅ 已有 | - | - |

### B. 风险与缓解措施

#### HIGH
- **[风险标题]**: [描述] → **缓解**: [方案]

#### MEDIUM
- **[风险标题]**: [描述] → **缓解**: [方案]

#### LOW
- **[风险标题]**: [描述] → **缓解**: [方案]

### C. 测试策略

#### 单元测试
- [测试场景]

#### 集成测试
- [测试场景]

#### E2E 测试
- [测试场景]

### D. 非目标 (Out of Scope)
- [明确不包含的功能，从 L4 答案提取]

### E. 安全检查项
[由安全关键词自动注入生成，详见 Phase 7.5]
```

#### PRD 模板（功能开发模式）

功能开发模式生成简化版 PRD，跳过 § 2/6，简化 § 3-5：

```markdown
# PRD: [功能名称]

## 1. 项目概述
[1 段描述]

## 3. 架构设计（概要）
[1 个 ASCII 工作流图]

## 4. 数据设计（概要）
| 模型 | 用途 | 关键字段 | 状态 |
[Schema 表格，不含完整 SQL]

## 5. UI 设计（概要）
| 组件 | Props | 状态 |
[组件清单表格，不含 ASCII 布局]

## 7. 开发计划
[Phase 列表 + 完整 DT 清单]

## 8. 附录
### A. 代码文件索引
### B. 风险与缓解措施
### D. 非目标
```

#### Dev Task 规则（不变）

- 每个任务要小而具体，能在一次迭代中完成
- 验收标准必须可验证
- 每个任务都要包含 "Typecheck passes"
- UI 任务要包含 "Verify in browser"
- **NEW：每个 DT 必须标注涉及的 API 路径、组件名或文件路径**
- **NEW：每个 Phase 必须标注前置依赖和对应的设计 Section**

---

### Phase 7.5: 安全检查自动注入（不变）

**在 Phase 7 生成所有 Dev Tasks 后、将 PRD 写入文件之前，执行以下安全扫描和自动注入。**

#### 扫描逻辑

逐个扫描每个 DT 的 title 和 description 文本，如果匹配以下关键词（不区分大小写），自动在该 DT 的 Acceptance Criteria 末尾（在 "Typecheck passes" 之前）追加对应的安全检查项：

| 触发关键词 | 自动追加的 Acceptance Criteria |
|------------|-------------------------------|
| 登录/认证/auth/密码/password/login | `- [ ] [安全] 密码使用 bcrypt/argon2 加密`<br>`- [ ] [安全] 使用 httpOnly cookies`<br>`- [ ] [安全] 登录接口设置速率限制` |
| 支付/payment/金额/price/checkout | `- [ ] [安全] 金额使用整数（分）存储避免浮点误差`<br>`- [ ] [安全] 支付接口验证签名`<br>`- [ ] [安全] CSRF 保护` |
| 用户输入/表单/form/input | `- [ ] [安全] 输入使用 schema 验证（如 zod）`<br>`- [ ] [安全] XSS 防护`<br>`- [ ] [安全] 字符串长度限制` |
| API/接口/endpoint/路由 | `- [ ] [安全] 使用参数化查询防止 SQL 注入`<br>`- [ ] [安全] 错误响应不泄露内部信息`<br>`- [ ] [安全] 添加权限检查` |
| 文件上传/upload/file | `- [ ] [安全] 文件类型白名单校验`<br>`- [ ] [安全] 文件大小限制`<br>`- [ ] [安全] 存储路径不可由用户控制` |
| 数据库/database/SQL/migration | `- [ ] [安全] 使用参数化查询`<br>`- [ ] [安全] 敏感字段加密存储`<br>`- [ ] [安全] 迁移脚本使用 IF NOT EXISTS` |

#### 注入规则

1. **`[安全]` 前缀**：所有注入的安全项必须以 `[安全]` 前缀标记
2. **多类别匹配**：一个 DT 可以匹配多个关键词类别，所有匹配类别的安全项都追加（去重）
3. **无匹配不注入**：不涉及安全关键词的 DT 不添加任何安全项
4. **Quick Fix 模式**：仅对高风险关键词注入（登录/认证/支付）
5. **Feature Build / Full Planning 模式**：所有六类关键词均触发注入

#### 安全项在 PRD 中的位置

- 注入到对应 DT 的验收标准中（§ 7 开发计划下的每个 DT）
- 同时汇总到 § 8.E 安全检查项附录中

---

## Transform Mode: PRD 导入流程

**适用场景：** 用户已有现成的 PRD/需求文档，需要转换为 BotoolAgent 标准格式（§ 1-8）并拆解为合格的开发任务 (DT)。

**核心原则：**
- 用户的 PRD 只是输入材料。BotoolAgent 始终需要自己格式的 PRD，包含正确粒度的 DT 分解。
- **生成的 PRD 只能比源 PRD 更全面，绝不能更少。** 源 PRD 中的所有设计细节（SQL Schema、代码示例、状态机定义、ASCII 图、业务规则）必须充分摘录到生成的 PRD 中，确保 Coding Agent 仅凭生成的 PRD 就能完成所有任务，无需回读源文件。
- 唯一可以省略的内容：版本更新日志 (Changelog)、会议纪要、与实现无关的背景叙述。

**触发条件：** 用户消息中包含 `[模式:导入]` 时进入 Transform 流程。

```
Phase T1 ──→ T2 ──→ T3 ──→ T4 ──→ T5 ──→ T6 ──→ L5确认 ──→ 生成PRD
获取文件    结构发现  覆盖评分  针对问答  DT分解   收敛门控  确认门控  输出PRD
            (Grep)   (打分)   (0-2轮)  (算法)   (复用)   (复用)
```

---

### Phase T1: 源文件获取

**目标：** 验证并读取用户的源 PRD 文件。

1. 从用户消息中提取文件路径（`[模式:导入]` 后面的部分）
2. 用 Read 工具验证文件存在
3. 如果文件 > 5000 行，标记为「大文件模式」
4. 在 metadata 中设置 `transformPhase: 'source-input'`、`sourcePrdPath: '<路径>'`
5. 告知用户："正在分析您的 PRD 文档..."

---

### Phase T2: 结构发现（两遍读取策略）

**目标：** 从源 PRD 中提取结构信息，按 BotoolAgent 维度分类。

**第一遍：提取目录结构**

1. 使用 Grep `^#{1,4}\s` 提取所有标题 → 得到 TOC + 行号
2. 按行号计算每个章节的大小
3. 将标题分类到 BotoolAgent 维度桶：

| 关键词匹配 | 目标维度 |
|------------|---------|
| 背景/概述/目标/Introduction/Summary | § 1 项目概述 |
| 当前/状态/现有/Current/Existing | § 2 当前状态 |
| 架构/设计/系统/Architecture/System | § 3 架构设计 |
| 数据/Schema/表/Database/Model/字段 | § 4 数据设计 |
| UI/界面/页面/组件/Component/布局 | § 5 UI 设计 |
| 规则/约束/权限/Rule/Constraint/流程 | § 6 业务规则 |
| 开发/Phase/阶段/计划/Task/任务/里程碑 | § 7 开发计划 |
| 附录/风险/测试/Appendix/安全 | § 8 附录 |

4. 输出分类结果

**第二遍：按维度桶充分读取（不截断）**

```
每个维度桶：
  - 计算该桶所有章节的总行数
  - 完整读取该维度桶的所有内容（不设行数上限）
  - 使用 Read 工具的 offset/limit 参数分段读取大章节
  - 提取所有设计细节：SQL 语句、代码示例、ASCII 图、状态机定义、业务规则
  - 关键内容原文保留，不要压缩或总结
```

**读取优先级：**
1. § 7（开发计划）和 § 4（数据设计）— 对 DT 分解最关键，优先读取
2. § 3（架构设计）和 § 6（业务规则）— 对实现质量关键
3. § 5（UI 设计）和 § 8（附录中的实现细节）— 对 Coding Agent 直接有用
4. § 1（概述）和 § 2（当前状态）— 背景信息
5. **跳过**：版本更新日志 (Changelog)、会议纪要、项目管理信息等与实现无关的内容

**Read 调用策略：**
- 不设固定上限，按需读取（模型上下文允许处理大量文本）
- 每次 Read 建议 500-1000 行，分段读取大章节
- 并行读取独立的维度桶以提高效率

在 metadata 中设置 `transformPhase: 'extraction'`

---

### Phase T3: 维度覆盖度评分

**目标：** 对每个 BotoolAgent 维度打分，决定后续动作。

#### 覆盖度级别

| 覆盖度 | 图示 | 含义 | 后续动作 | 摘录策略 |
|--------|------|------|----------|----------|
| FULL | ████ | 内容充分，可直接提取 | 自动映射，不提问 | **原文摘录**：SQL、代码、ASCII 图、规则表逐字复制到生成 PRD |
| HIGH | ███░ | 基本覆盖，有小模糊点 | 1-2 个确认性问题 | **原文摘录 + 补充**：核心内容逐字复制，模糊点通过问答补充后写入 |
| PARTIAL | ██░░ | 部分内容，关键部分缺失 | 3-5 个针对性问题 | **部分摘录 + 生成**：已有内容摘录，缺失部分通过问答生成 |
| SPARSE | █░░░ | 几乎没有内容 | 复用现有 L2/L3 问题模板 | **全部生成**：通过问答从零生成该维度内容 |

#### 评分标准

| 维度 | FULL | HIGH | PARTIAL | SPARSE |
|------|------|------|---------|--------|
| § 1 概述 | 有目标+指标+背景 | 有目标无指标 | 只有项目名 | 无 |
| § 3 架构 | 有架构图+角色+流程 | 有高层设计 | 提到架构 | 无 |
| § 4 数据 | 有 SQL/ORM + 字段+约束 | 有表+部分字段 | 提到表名 | 无 |
| § 5 UI | 有线框图+页面+组件清单 | 有页面列表 | 提到页面 | 无 |
| § 6 规则 | 有规则表+决策树 | 有规则描述 | 提到约束 | 无 |
| § 7 计划 | 有 Phase+细粒度任务+文件 | 有 Phase+粗任务 | 有任务列表 | 无 |

#### 展示覆盖度分析

使用 AskUserQuestion 向用户展示覆盖度分析结果：

```json
{
  "questions": [
    {
      "question": "───────── PRD 覆盖度分析 ─────────\n┌────────────────┬──────┬──────────────────────────┐\n│ 维度           │ 覆盖 │ 说明                      │\n├────────────────┼──────┼──────────────────────────┤\n│ § 1 项目概述    │ ████ │ 充分 — 直接提取            │\n│ § 3 架构设计    │ ███░ │ 高 — 需确认角色权限        │\n│ § 4 数据设计    │ ████ │ 充分 — 含 SQL Schema      │\n│ § 5 UI 设计     │ ██░░ │ 部分 — 缺组件清单/布局    │\n│ § 6 业务规则    │ █░░░ │ 稀缺 — 需补充             │\n│ § 7 开发计划    │ ███░ │ 高 — Phase 级，需拆解 DT   │\n└────────────────┴──────┴──────────────────────────┘\n\n将对覆盖不足的维度进行针对性问答。\n§ 7 的 Phase 级任务将自动拆解为开发任务 (DT)。\n\n确认后开始补充问答？",
      "header": "覆盖度分析",
      "options": [
        { "label": "确认，开始补充", "description": "对覆盖不足的维度进行针对性问答" },
        { "label": "跳过补充，直接转换", "description": "以现有内容直接生成，缺失部分留空" }
      ],
      "multiSelect": false
    }
  ],
  "metadata": {
    "source": "pyramidprd",
    "level": 2,
    "levelName": "Transform: 覆盖度分析",
    "progress": "T3/T6",
    "totalLevels": 5,
    "transformPhase": "gap-analysis",
    "gapAnalysis": {
      "dimensions": [
        { "section": "§ 1", "name": "项目概述", "coverage": "full", "note": "充分 — 直接提取" }
      ]
    }
  }
}
```

**注意：** 上方 ASCII 表格中的内容应根据实际分析结果动态生成，示例仅供参考格式。

用户确认后进入 Phase T4。如果用户选择「跳过补充」，直接跳到 Phase T5。

---

### Phase T4: 针对性问答（仅 PARTIAL/SPARSE 维度）

**核心原则：不重复问用户 PRD 中已有的内容。**

对每个需要补充的维度，复用现有 L2/L3 问题模板，但只选择相关子集：

```
如果 § 5 UI 是 PARTIAL：
  → 复用 L2 的 uiStructure 问题（页面列表、组件、布局）
  → 跳过 L2 的其他维度

如果 § 6 规则是 SPARSE：
  → 复用 L3 的「业务规则」和「状态流转」问题
  → 同时复用 L2 的 backend 部分问题（权限、约束）

如果 § 3 架构是 PARTIAL：
  → 复用 L2 的 architecture 问题
  → 跳过已有的高层设计部分

如果 § 4 数据是 PARTIAL：
  → 复用 L2 的 dataModel 问题
  → 跳过已有表名，只问缺失字段和约束
```

**限制：最多 2 轮问答（每轮批量提问），防止过长。**

使用 AskUserQuestion 时的 metadata：
```json
{
  "metadata": {
    "source": "pyramidprd",
    "level": 3,
    "levelName": "Transform: 针对性问答",
    "progress": "T4/T6",
    "totalLevels": 5,
    "transformPhase": "targeted-qa"
  }
}
```

---

### Phase T5: DT 分解算法

**目标：** 将用户 PRD 的 Phase 级任务拆解为迭代级 DT。这是 Transform Mode 的核心价值。

在 metadata 中设置 `transformPhase: 'dt-decomposition'`

#### 分解规则

| 用户任务关键词 | 拆分策略 |
|---------------|---------|
| CRUD / 增删改查 | 4 个 DT（每个操作一个） |
| 管理页面 | 3-4 个 DT（列表 + 表单 + 详情 + 路由） |
| 翻译/国际化 | 3-5 个 DT（API + 状态机 + 进度 UI + 集成） |
| 导入导出 | 2-3 个 DT（解析器 + UI + 集成） |
| 审批流 | 4-5 个 DT（Schema + 状态机 + API + UI + 通知） |

#### 分解流程

```
对每个用户 Phase:
  1. 计数「scope 信号」：API 路由数 + 页面数 + 新建表数 + 组件数
  2. 信号 ≤ 2 → 保持为 1 个 DT
  3. 信号 3-5 → 按层拆分（DB → API → UI），2-3 个 DT
  4. 信号 6+ → 按功能切片拆分，4-7 个 DT
  5. 每个 DT 生成：
     - 标题含文件/API/组件引用
     - 验收条件（从用户 PRD 提取 + 改写）
     - prdSection 指向生成的 PRD § 7.X
     - dependsOn 依赖链
```

#### DT 格式（写入 BotoolAgent PRD § 7）

```markdown
### 7.2 Phase 2: 文档库管理 (P0)

> **前置**: Phase 1
> **产出**: 管理员可创建/编辑/管理 PPT 文档
> **对应设计**: Section 3.5-3.6, 8.9

- [ ] DT-005: 文档库列表 API (GET /api/presentations, 含分页+筛选) (`文件: app/api/presentations/route.ts`)
- [ ] DT-006: 文档库管理页面 — 列表视图 (`组件: <DocumentLibrary>`, `页面: /library/admin`)
- [ ] DT-007: 新增 PPT 功能 (POST /api/presentations + 编辑器跳转) (`文件: app/api/presentations/route.ts`)
- [ ] DT-008: 分享功能 — API + ShareDialog 组件 (`API: /api/presentations/[id]/collaborators`, `组件: <ShareDialog>`)
- [ ] DT-009: 访问请求 — API + AccessRequestView (`API: /api/presentations/[id]/access-requests`, `组件: <AccessRequestView>`)
```

---

### Phase T6: 收敛到 L5 确认门控

**目标：** DT 分解完成后，收敛到现有的 L5 确认门控流程。

```
Phase T6 输出 → 喂入现有 Phase 6 (L5 Confirmation Gate, 2 轮 Tabs)
  第 1 轮: 项目概述 | 核心架构 | 用户角色 | 核心工作流
  第 2 轮: 数据模型 | 关键 UI  | 业务规则 | 总确认
```

**按模式裁剪 L5 步骤：** Transform 模式使用与「完整规划」相同的 L5 配置（2 轮 x 4 Tabs 全部展示），因为用户的原始 PRD 通常涵盖较多维度。

用户确认后，进入 Phase 7（PRD 生成）生成标准 BotoolAgent PRD。

---

### Transform Mode: PRD 生成规则（Phase 7 特化）

**Transform 模式生成 PRD 时，除遵循通用 Phase 7 模板外，还必须遵守以下充分摘录规则：**

#### 充分摘录原则

生成的 BotoolAgent PRD **必须是自给自足的文档**。Coding Agent 不应需要回读源 PRD。

#### 各维度摘录规则

| 维度 | 摘录规则 | 示例 |
|------|---------|------|
| **§ 4 数据设计** | **SQL CREATE TABLE 语句逐字复制**，包括所有字段、类型、约束、默认值、注释。RLS 策略定义也完整复制。 | 源 PRD 的 9 个 CREATE TABLE → 全部复制到 § 4.2 |
| **§ 3 架构设计** | **状态机完整定义**（状态列表 + 转换规则 + 触发条件）。**工作流 ASCII 图**完整复制。角色权限矩阵完整复制。 | 源 PRD 的版本状态机 draft→published → 完整复制 |
| **§ 5 UI 设计** | **ASCII 线框图**完整复制（每个关键页面和弹窗）。**组件 Props 接口**完整列出。交互状态（hover/active/disabled）描述。 | 源 PRD 的 8+ ASCII 线框图 → 全部复制 |
| **§ 6 业务规则** | **规则表格**完整复制。**决策树**完整复制。每条规则的影响范围（关联 DT）必须标注。 | 源 PRD 的 80+ 规则 → 全部复制到 § 6 |
| **§ 8 附录** | **实现方案代码示例**完整复制（TypeScript/SQL/API 签名）。文件索引表完整。API 端点列表完整。 | 源 PRD Appendix E 的导出/导入代码 → 复制到 § 8.F 技术实现详情 |
| **§ 7 开发计划** | 不摘录源 PRD 的原始任务列表，而是使用 T5 DT 分解算法的输出。每个 DT 的验收条件从源 PRD 提取关键点。 | 源 PRD 60 个 checklist → 拆解为 35-80 个 DT |

#### 可省略内容

以下内容不需要摘录到生成的 PRD 中：
- **版本更新日志** (Changelog) — 与实现无关
- **会议纪要/讨论记录** — 与实现无关
- **重复的叙述性描述** — 如果同一信息在源 PRD 中出现多次，只需保留最完整的版本
- **项目管理信息**（负责人、截止日期等）— BotoolAgent 有自己的进度管理

#### 预期文档长度

| 源 PRD 长度 | 生成 PRD 预期长度 | 说明 |
|------------|------------------|------|
| < 500 行 | ≈ 源 PRD 的 1.5-2x | 补充缺失维度会增加内容 |
| 500-2000 行 | ≈ 源 PRD 的 0.8-1.5x | 充分摘录 + 结构化重组 |
| 2000-5000 行 | ≈ 源 PRD 的 0.6-1.2x | 去除 Changelog 等冗余，核心内容全部保留 |
| > 5000 行 | ≈ 2000-4000 行 | 大文件去冗余后仍应保持高信息密度 |

**关键指标：** 如果源 PRD 有 SQL Schema、代码示例、ASCII 图、规则表，生成的 PRD 中这些内容的行数不应少于源 PRD 中对应内容的 80%。

#### 文件管理

**自动检测 tasks 目录（兼容 standalone 和 portable 模式）：**
```bash
TASKS_DIR="$([ -d BotoolAgent/tasks ] && echo BotoolAgent/tasks || echo tasks)"
```

```
$TASKS_DIR/
  [user-original].md         ← 用户原始 PRD（不修改，保持原位）
  prd-[feature-name].md      ← 生成的 BotoolAgent PRD（标准格式）
```

用户原始文件不动，不复制。BotoolAgent PRD 作为新文件写入 `$TASKS_DIR/`。

---

## 关键原则

1. **立即开始提问** - 收到需求后直接开始 L1，不做冗长分析
2. **使用 AskUserQuestion** - 所有问题都通过工具提问
3. **包含 metadata** - 每次提问必须带 level 信息
4. **层级递进** - 严格按 L1→L2→L3→L4→L5（确认）顺序
5. **动态调整** - 根据答案调整后续问题
6. **简洁反馈** - 每层完成后简短总结，立即进入下一层
7. **ASCII 可视化** - L5 门控和 PRD 文档中使用 ASCII 图表达架构/UI/数据/流程
8. **高颗粒度** - DT 必须包含具体的 API 路径、组件名、文件路径
9. **交叉引用** - Phase 必须标注对应的设计 Section

---

## 完成后

生成 PRD 后，告诉用户：

"PRD 已生成。下一步：
1. 查看并确认 PRD 内容
2. 使用 `/botoolagent-prd2json` 转换为 JSON（精简版，只包含自动化必需字段）
3. 运行 `/botoolagent-coding` 开始自动开发

Coding agent 会读取 prd.json 找到下一个任务，然后跳读 PRD.md 中对应的设计章节获取完整上下文。"
