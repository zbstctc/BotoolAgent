# Botool 开发代理进度日志
开始时间: Mon Feb  2 22:52:48 CST 2026

## Codebase Patterns
- PRD 模式的 System Prompt 在 `viewer/src/app/api/cli/chat/route.ts` 的 `PRD_SYSTEM_PROMPT` 常量中定义
- 该文件支持三种模式：prd、convert、default，通过 `getSystemPrompt()` 函数切换
- AskUserQuestion 工具的 questions 数组可以一次包含 2-4 个问题
- AskUserQuestion 问题类型：有 options 的选择题，无 options 的文本输入题（通过 `isTextInputQuestion()` 判断）
- localStorage 会话进度保存在 `viewer/src/lib/prd-session-storage.ts`，键为 `botool-prd-session`
- Stage 1 页面有两种会话恢复机制：服务端 session（通过 prdId）和 localStorage 本地会话

---

## 2026-02-02 23:01 - DT-002
- 实现了什么：改进触发按钮显示问题数量和主题标签
- 修改了哪些文件：`viewer/src/components/ToolRenderer.tsx`
- **未来迭代的经验教训：**
  - ToolRenderer 组件在 `viewer/src/components/ToolRenderer.tsx`
  - 触发按钮和 Modal 都在 `AskUserQuestionRenderer` 函数组件内
  - `input.questions` 包含所有问题，每个问题有 `header` 属性表示主题
  - 现有 lint 错误 (set-state-in-effect) 是遗留问题，不阻塞开发
  - 需要手动浏览器验证，因为 Playwright 无法启动（Chrome 已有运行实例）
---

## 2026-02-02 23:15 - DT-003
- 实现了什么：确认 Modal 进度和编号功能已在 DT-002 中实现
- 修改了哪些文件：无代码修改，仅更新 prd.json
- **未来迭代的经验教训：**
  - DT-002 和 DT-003 的功能紧密相关，在 DT-002 实现时一并完成了 Modal 内的所有改进
  - Modal 内的功能包括：标题显示问题数、问题编号、绿色勾选标记、底部进度「已回答 X/Y」
  - 验证 typecheck 通过
  - 需要手动浏览器验证
---

## 2026-02-02 23:XX - DT-001
- 实现了什么：更新 PRD_SYSTEM_PROMPT 支持批量中文问题
- 修改了哪些文件：`viewer/src/app/api/cli/chat/route.ts`
- **未来迭代的经验教训：**
  - System Prompt 使用模板字符串，修改时注意 JSON 示例中的转义
  - AskUserQuestion 的 questions 数组是核心机制，每个问题需要 question、header、options、multiSelect 字段
  - 问题分组建议按主题：基础信息、功能范围、技术方案、验收标准
---

## 2026-02-03 00:XX - DT-004
- 实现了什么：支持文本输入类型问题（无预设选项）
- 修改了哪些文件：
  - `viewer/src/lib/tool-types.ts` - 让 options 变为可选，添加 inputType、placeholder 字段，添加 isTextInputQuestion 辅助函数
  - `viewer/src/components/OptionCard.tsx` - 添加 textInputOnly 模式，支持单行 (text) 和多行 (textarea) 文本输入
  - `viewer/src/components/ToolRenderer.tsx` - 处理没有预设选项的文本输入问题
- **未来迭代的经验教训：**
  - `isTextInputQuestion()` 辅助函数判断问题是否为纯文本输入（没有 options 或 options 为空数组）
  - OptionCard 的 `textInputOnly` prop 控制是否只显示文本输入框
  - 文本输入类型通过 `inputType` 属性控制：'text' 单行，'textarea' 多行
  - 当 options 可选时，TypeScript 需要额外的空值检查（使用 `!` 断言或条件判断）
  - 需要手动浏览器验证
---

## 2026-02-03 01:XX - DT-005 & DT-006
- 实现了什么：问答进度保存到 localStorage，支持会话恢复（DT-005 和 DT-006 一并实现）
- 修改了哪些文件：
  - `viewer/src/lib/prd-session-storage.ts` - 新文件，管理 localStorage 保存和读取
  - `viewer/src/components/ToolRenderer.tsx` - 从 localStorage 初始化状态，答案变化时自动保存
  - `viewer/src/components/SessionResumeDialog.tsx` - 扩展支持显示进度信息（回答 X/Y 个问题、上次更新时间）
  - `viewer/src/app/stage1/page.tsx` - 检测 localStorage 中未完成会话并显示恢复对话框
- **未来迭代的经验教训：**
  - localStorage 键为 `botool-prd-session`，存储 `SavedPrdSession` 对象
  - `getSavedPrdSession()` 和 `saveQuestionAnswers()` 是核心函数
  - 在 ToolRenderer 中使用 useEffect 保存，但需注意依赖数组避免无限循环
  - 移除了 set-state-in-effect 问题，改用初始化函数计算 modal 状态
  - SessionResumeDialog 需要传入 `currentTime` 来避免 render 期间调用 Date.now() 的纯度问题
  - DT-005 和 DT-006 功能紧密相关，一并实现更高效
  - 需要手动浏览器验证
---
