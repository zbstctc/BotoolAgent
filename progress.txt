# Botool 开发代理进度日志
开始时间: Wed Feb 18 16:06:06 CST 2026
---

## 2026-02-18 - DT-001
- 更新 ConstitutionRule TypeScript 类型：新增 `file: string` 和 `checklist: string[]`
- 修改了：`viewer/src/lib/tool-types.ts`, `viewer/src/app/api/prd/merge/route.ts`（临时默认值）
- **未来迭代的经验教训：**
  - ConstitutionRule 新字段 required 会导致下游文件 typecheck 失败，需同步修复
  - prd.json 中现有 constitution rules 只有 `content`，运行时检测用 `rule.file ? "新" : "旧"`
---

## 2026-02-18 - DT-002
- 更新 merge route：RuleInput 新增 file/checklist 字段，mergeEnrichedPrdJson 写入 file+checklist
- 新增规范融合函数 fuseRulesIntoPrdMd()：读取 PRD.md §7，注入 [规范] 条目，幂等执行
- 修改了：`viewer/src/app/api/prd/merge/route.ts`
- **未来迭代的经验教训：**
  - 规范融合是「最佳努力」操作，PRD 格式不匹配时静默跳过
  - 函数幂等：重复执行会先清除旧 [规范] 行再重新注入
---

## 2026-02-18 - DT-003
- 更新 review-summary route：新增 totalChecklistItems 字段，统计 constitution rules 的 checklist 总条数
- 确认只依赖 name/id/checklist，不依赖 content
- 修改了：`viewer/src/app/api/review-summary/route.ts`
- **未来迭代的经验教训：**
  - review-summary 通过 parsePrdData 解析 JSON，用 Array.isArray 防御性检查 checklist
  - 安全：错误响应返回通用消息，不泄露内部路径
---

## Session 结束 — 已完成 3 个，剩余 10 个留给下一 session
S1 (DT-001, DT-002, DT-003) 全部通过。下一 session: S2 (DT-004, DT-005)。

## 2026-02-18 - DT-004
- PRD2JSON SKILL 新增「规范融合」章节（Step 3: Constitution Fusion）
- constitution schema 更新为 file+checklist 模式（取代 content）
- 新增向后兼容检测逻辑（Q4）和 checklist 条数校验（3-8 条）
- 修改了：`skills/BotoolAgent/PRD2JSON/SKILL.md`
- **未来迭代的经验教训：**
  - SKILL.md 中有两处 constitution 示例 JSON 需要同步更新（Output Format + Example）
  - 规范融合规则使用关键词匹配策略，需根据实际使用反馈调整匹配精度
---

## 2026-02-18 - DT-005
- PRD2JSON SKILL 新增 steps 生成规则章节（5 种 action 类型）
- 新增颗粒度规则文档：每步可单条命令验证，3-6 步
- 更新 Field Reference 和示例 JSON 包含 steps 字段
- 修改了：`skills/BotoolAgent/PRD2JSON/SKILL.md`
- **未来迭代的经验教训：**
  - steps 是可选字段，简单 DT 不需要生成
  - 判断标准：≥ 2 个文件或有明确顺序约束时生成 steps
---

## Session 结束 — 已完成 5 个，剩余 8 个留给下一 session
S2 (DT-004, DT-005) 全部通过。下一 session: S3 (DT-006, DT-007, DT-008, DT-009)。

## 2026-02-18 - DT-006
- CLAUDE.lead.md 新增「验证铁律」章节：要求 Lead 独立运行所有 evals 后才能标记 passes: true
- 包含禁止行为列表（信任口头报告、should pass、跳过 eval）
- 修改了：`CLAUDE.lead.md`
- **未来迭代的经验教训：**
  - 验证铁律放在单任务执行协议和进度报告之间
  - 是所有 DT 验收的前置条件
---

## 2026-02-18 - DT-007
- CLAUDE.lead.md 新增「DT 双阶段 Review」章节：Stage A (Spec + Constitution) + Stage B (Quality Check)
- Stage A 包含 constitution checklist 合规检查（不合规=FAIL，不确定=读 rule.file）
- 完整流程图：验证铁律 → Stage A → Stage B → passes: true
- 修改了：`CLAUDE.lead.md`
- **未来迭代的经验教训：**
  - Spec Review 的少了=FAIL、多了=WARNING 分级很关键
  - constitution checklist 的不确定处理路径（读 rule.file）是安全网
---

## 2026-02-18 - DT-008
- CLAUDE.lead.md 升级 Teammate prompt 模板：支持 steps 模式 + 旧模式、evals 全量运行、报告含完整输出
- 模式 A (slim prdFile+prdSection) 和模式 B (fat description/acceptanceCriteria) 分离
- steps 存在时按步骤顺序执行，不存在时走通用实现流程
- 修改了：`CLAUDE.lead.md`
- **未来迭代的经验教训：**
  - Teammate prompt 需要显式列出 task.evals 中的其他命令，不能只写 typecheck
  - [规范] 条目不确定时有后备路径（读 Phase 头部规范文件）
---

## 2026-02-18 - DT-009
- CLAUDE.lead.md 升级验收流程：多任务和单任务路径都改为 独立验证 → Stage A → Stage B → passes: true
- 失败时有明确的修复 → 重新验证路径
- 修改了：`CLAUDE.lead.md`
- **未来迭代的经验教训：**
  - 单任务执行协议中去掉了 typecheck 单独步骤（被 evals 全量覆盖）
  - 验收流程结构化为 4 步（独立验证/Spec Review/Quality Check/标记通过）
---

## Session 结束 — 已完成 9 个，剩余 4 个留给下一 session
S3 (DT-006, DT-007, DT-008, DT-009) 全部通过。下一 session: S4 (DT-010, DT-011, DT-012)。
