# Botool 开发代理进度日志
开始时间: Thu Feb 12 10:48:23 CST 2026
---

## 2026-02-12 - DT-001
- 实现了 Stage 3 代理进程防重复启动 + 孤儿检测
- 修改了：viewer/src/app/api/agent/start/route.ts、viewer/src/app/api/agent/status/route.ts、viewer/src/app/stage3/page.tsx、viewer/src/lib/project-root.ts、.gitignore
- **未来迭代的经验教训：**
  - 模式：PID 锁文件放在 getBotoolRoot()/.agent-pid，用 process.kill(pid, 0) 检测存活
  - 模式：status/route.ts 的 SSE poll 是做各种实时检测的好位置（每 500ms 执行一次）
  - 模式：checkAndHandleOrphan() 同时在 GET 和 SSE 两种模式下都执行
  - getAgentPidPath() 已加入 project-root.ts 工具函数库
---

## 2026-02-12 - DT-002
- 修复了 EnrichmentSummary 保存失败后仍跳转的 bug
- 修改了：viewer/src/components/pipeline/EnrichmentSummary.tsx
- **未来迭代的经验教训：**
  - 模式：catch 块永远不要调用成功回调（onComplete），应显示错误 + 重试
  - 模式：保存按钮可以有三种状态：正常（绿色）、保存中、重试（橙色）
  - updateProject() 是同步的（React state），不会抛异常
  - prd.json schema 验证放在 handleSave 开头（branchName 必填、devTasks 非空）
---

## 2026-02-12 - DT-003
- 新增 TestCase 类型定义，DevTask/EnrichedDevTask 支持 testCases 字段
- 修改了：viewer/src/lib/tool-types.ts、viewer/src/hooks/useFileWatcher.ts、viewer/src/app/stage3/page.tsx
- **未来迭代的经验教训：**
  - 类型定义分散：tool-types.ts 有 EnrichedDevTask，useFileWatcher.ts 有 DevTask — 两处都需同步
  - TestCase 定义在两处：tool-types.ts（完整版）和 useFileWatcher.ts（Stage 3 用）
  - Stage 4 会在 DT-007 大规模重构，此处不需修改
---

## 2026-02-12 - DT-005
- Stage 3→4 自动串联：倒计时 + 自动跳转 + Stage 4 自动开始验收
- 修改了：viewer/src/components/StageTransitionModal.tsx、viewer/src/app/stage3/page.tsx、viewer/src/app/stage4/page.tsx
- **未来迭代的经验教训：**
  - StageTransitionModal 现在支持 autoCountdown prop，可复用于其他 stage 转换
  - Stage 4 的 handleRunTests 需要在 useEffect 之前定义（因为 useCallback 有依赖链）
  - autoStarted ref 防止在 strictMode 下重复启动
---

## 2026-02-12 - DT-004
- 在 CLAUDE.md 新增"测试驱动开发"章节
- 修改了：CLAUDE.md
- **未来迭代的经验教训：**
  - CLAUDE.md 步骤编号需要手动维护一致性
  - testCases 和 spec.testCases 是不同的字段：前者是 DT-003 新增的顶级字段，后者是 SDD 增强中的 spec 内部字段
---

## 2026-02-12 - DT-013
- 重构 /botoolagent-coding skill SKILL.md 为 CLI 全自动流水线
- 修改了：skills/BotoolAgent/Coding/SKILL.md
- **未来迭代的经验教训：**
  - SKILL.md 的 bash 代码块应是独立命令（Claude 逐步执行），不要写成完整 shell 脚本（if/then/fi）
  - 控制流放在 markdown 文本中（"**如果失败：**" + "Then stop here."），不放在 bash 里
  - 其他 SKILL.md 的格式参考：skills/BotoolAgent/Main/SKILL.md、PRD2JSON/SKILL.md
  - CLI 流水线 Step 2→3→4 对应 Viewer Stage 3→4→5
---

## 2026-02-12 - DT-014
- Stage 1 CLI 心跳检测 + 自动重连 + ErrorRecovery 集成
- 新建了：viewer/src/app/api/cli/health/route.ts（健康检查端点）
- 修改了：viewer/src/hooks/useCliChat.ts、viewer/src/hooks/index.ts、viewer/src/app/stage1/page.tsx
- **未来迭代的经验教训：**
  - useCliChat 的 CLI 通信是 per-request 的（每次 sendMessage 创建新的 CLIManager），不是持久连接
  - 心跳检测的是**服务端**可达性（/api/cli/health），不是 CLI 进程存活
  - auto-retry 包裹在 fetchWithRetry 中，对 sendMessage 和 respondToTool 都生效
  - ConnectionState 类型导出需要在 hooks/index.ts 中同步添加
  - ErrorRecovery 组件来自 DT-009，props: error, diagnosis?, actions[]
---
