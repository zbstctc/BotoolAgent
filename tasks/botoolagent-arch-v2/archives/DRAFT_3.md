# Draft 3: PyramidPRD 问答加速 — 方案卡批量确认机制

> Stage 0 头脑风暴产出 | 日期: 2026-02-26
> 前置: DRAFT_2.md (上下文爆炸修复 + 大文件处理)

## 定位

将 PyramidPRD 的逐题问答模式改为「方案卡批量确认」模式，每层只需 1 次交互。用户看到完整方案（含所有选项 + AI 推荐标记），一次确认或精准修改。

## 背景与动机

### 当前问题

| 问题 | 影响 |
|------|------|
| **逐题问答** | 5 层 × 3-12 题 = 最多 22-43 次交互，~30 分钟 |
| **技术题问非技术用户** | "API 类型? 认证方式?" → 用户不懂，只能盲选 |
| **不是每题都有推荐** | 用户想"你帮我选"但没这个选项 |
| **修改路径太绕** | 用户选"我有不同想法" → AI 追问哪里不同 → 用户解释 → 多 2-3 轮 |

### 核心洞察

用户不需要逐题选择。他们需要的是：
1. 看到 AI 的完整推荐方案
2. 快速确认（80% 的情况下直接接受）
3. 精准修改（20% 的情况下改 1-2 项，直接说"第 3 题换 B"）

## 核心方案：方案卡批量确认

### 方案卡格式

**每层问答从 N 个 AskUserQuestion 合并为 1 个方案卡。** 方案卡在 question 文本中列出所有问题、所有选项和 AI 推荐，用户只需选择「全部接受」或输入修改指令。

**方案卡模板：**

```
【L2: 领域分支 — AI 方案卡】

基于: [L0方向] + [L1核心] + [代码扫描结果]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

 Q1. 页面结构
   A) 单页应用 — 全部功能在一个页面内
   B) 管理面板 — 左侧导航 + 右侧内容区  ← 匹配现有 viewer
   C) 多标签页 — 顶部 Tab 切换不同功能区
   → AI 选择: B

 Q2. API 设计模式
   A) RESTful 路由 (GET/POST/PUT/DELETE)  ← 匹配现有 /api/
   B) Server Actions (Next.js 14 内置)
   C) tRPC 端到端类型安全
   → AI 选择: A

 Q3. 认证方式
   A) JWT + httpOnly cookies  ← 匹配现有项目 auth
   B) Session 认证
   C) OAuth 第三方登录
   D) 无需认证
   → AI 选择: A

 Q4. 数据存储
   A) PostgreSQL + Prisma  ← 匹配现有 schema.prisma
   B) SQLite (轻量本地存储)
   C) MongoDB
   → AI 选择: A

 Q5. 状态管理
   A) React useState + SWR  ← 匹配现有模式
   B) Zustand
   C) Redux
   → AI 选择: A

 Q6. 核心 UI 组件
   A) shadcn DataTable + Form + Dialog  ← 匹配现有 UI 库
   B) 自定义卡片网格 + 抽屉面板
   C) Kanban 看板视图
   → AI 选择: A

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
要修改请在下方 Type something 中输入如 "Q3 换 B"
```

### UI 框架约束与选项设计

Claude Code 的 AskUserQuestion 有以下固定 UI 元素（无法去除）：
- **Type something** (Other) — 内置自由文本输入
- **Chat about this** — 内置对话选项

因此方案卡的 options **只放 2 个选项**，利用内置 Other 作为修改入口：

```
UI 显示效果:
  1. 全部接受 (推荐)                            ← 80% 用户直接选
  2. ↓ 请在下方 Type something 输入修改          ← 引导用户到 3
  3. Type something.                             ← 用户输入 "Q3 换 B"
  4. Chat about this                             ← 内置，忽略
```

**AskUserQuestion 结构：**

```json
{
  "questions": [
    {
      "question": "【方案卡内容（含全部 Q 和 ABCD 选项 + AI 推荐标记）】\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n要修改请在下方 Type something 中输入如 \"Q3 换 B\"",
      "header": "L2 领域分支",
      "options": [
        {
          "label": "全部接受 (推荐)",
          "description": "按 AI 推荐方案继续，进入下一层"
        },
        {
          "label": "↓ 请在下方 Type something 输入修改",
          "description": "输入如 'Q3 换 B' 或 'Q4 换 C, Q6 换 B'"
        }
      ],
      "multiSelect": false
    }
  ],
  "metadata": {
    "source": "pyramidprd",
    "level": 2,
    "levelName": "L2: 领域分支",
    "mode": "batch-confirm"
  }
}
```

### 用户交互示例

**场景 1: 全部接受（最常见，~80%）**
```
用户: 选择 [全部接受 (推荐)]
→ 写入 qa-journal.md, 进入下一层
```

**场景 2: 精准修改（~15%）**
```
用户: 在 Type something 中输入 "Q3 换 B, Q5 换 B"
→ AI 解析: Q3=Session认证, Q5=Zustand，其余保持 AI 推荐
→ 写入 qa-journal.md, 进入下一层
```

**场景 3: 用户选了选项 2（引导项）**
```
用户: 选择 [↓ 请在下方 Type something 输入修改]
→ AI 回复: "请在文本框中输入修改指令，如 'Q3 换 B'。"
→ 用户下一轮输入具体修改
```

### 推荐选择规则

**强制规则：每个 Q 必须有且仅有一个 AI 推荐，无例外。**

推荐依据优先级：

| 优先级 | 依据来源 | 示例 |
|--------|---------|------|
| 1 | 代码库扫描 | 项目用 Prisma → 推荐 PostgreSQL + Prisma |
| 2 | L0 方向 + 前序层级回答 | 用户选了"管理面板" → 推荐 DataTable 组件 |
| 3 | 行业最佳实践 | 无代码库 + 新项目 → 推荐当前主流方案 |
| 4 | 最安全/最简单选项 | 无法判断时 → 推荐最稳妥的选项 |

**推荐标记格式：**
- 选项后标注 `← [推荐理由]`（简短，如"匹配现有项目"）
- `→ AI 选择: X (推荐)` 放在每题末尾（醒目）

### 问题分类：业务题 vs 技术题

| 分类 | 特征 | 在方案卡中的表现 |
|------|------|-----------------|
| **业务题** | 目标用户、核心价值、范围、业务规则 | 选项用业务语言描述，推荐理由基于用户需求 |
| **技术题** | API 类型、数据库、框架、认证 | 选项含技术名词，但推荐理由用白话：`← 匹配你现有项目` |

**关键原则：** 技术题不需要用户真正理解技术细节。方案卡的设计让用户可以完全信任 AI 推荐（选"全部接受"），只在业务层面有意见时才修改。

---

## 各层方案卡设计

### L0: 方向探索（保持现有 2 次交互）

L0 的方向选择和范围确认是**战略性决策**，不适合批量确认。保持当前设计（含 markdown 预览的 AskUserQuestion）。

### L1: 核心识别 — 方案卡

```
【L1: 核心识别 — AI 方案卡】

基于: [用户初始描述] + [L0方向选择]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Q1. 问题域
  A) [领域1]  ← 从需求描述推断
  B) [领域2]
  C) [领域3]
  → AI 选择: A

Q2. 目标用户
  A) [用户群1]  ← 从需求描述推断
  B) [用户群2]
  C) 多角色 ([群1] + [群2])
  → AI 选择: A

Q3. 核心价值
  A) [价值主张1]
  B) [价值主张2]
  → AI 选择: A

Q4. 规模预期
  A) MVP — 最小可用版本  ← 适合首次迭代
  B) 完整功能 — 覆盖全部需求
  C) 可扩展框架 — 预留扩展点
  → AI 选择: A

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
要修改请在下方 Type something 中输入如 "Q3 换 B"
```

### L2: 领域分支 — 方案卡

（见上方完整示例）

### L3: 细节深入 — 方案卡

```
【L3: 细节深入 — AI 方案卡】

基于: [L1核心] + [L2领域] + [代码扫描]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[如果有表单]
Q1. 表单验证
  A) Zod schema 验证 (前后端复用)  ← 匹配现有项目模式
  B) 仅前端验证 (react-hook-form)
  C) 仅后端验证
  → AI 选择: A

Q2. 错误提示方式
  A) 字段内联红字提示  ← 最常见模式
  B) 顶部 toast 汇总
  C) 弹窗提示
  → AI 选择: A

[如果有列表]
Q3. 分页方式
  A) 翻页式分页 (页码导航)  ← 管理面板标准
  B) 无限滚动加载
  C) 一次全量加载
  → AI 选择: A

[如果有状态流转]
Q4. 状态机复杂度
  A) 简单线性 (draft → published → archived)  ← 3 状态
  B) 带分支 (draft → review → approved/rejected → published)
  C) 复杂工作流 (需要单独设计)
  → AI 选择: [根据需求推断]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
要修改请在下方 Type something 中输入如 "Q3 换 B"
```

### L4: 边界确认 — 方案卡

```
【L4: 边界确认 — AI 方案卡】

基于: [全部前序层级] + [代码扫描]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Q1. 需要修改的现有文件
  A) 仅新增文件，不改现有代码
  B) 修改 [列出具体文件名]  ← 基于代码扫描推断
  C) 不确定
  → AI 选择: B

Q2. 排除范围 (YAGNI)
  A) 不含 [排除项1], [排除项2], [排除项3]  ← AI 推断
  B) 不含 [更大排除列表]
  C) 我来指定
  → AI 选择: A

Q3. 性能要求
  A) 标准 (无特殊要求)  ← 大多数场景
  B) 高性能 (需要缓存/优化)
  C) 实时 (WebSocket/SSE)
  → AI 选择: A

Q4. MVP 延后项
  A) [推后功能1], [推后功能2]  ← AI 根据 L1.Q4 推断
  B) 全部一期做完
  → AI 选择: A

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
要修改请在下方 Type something 中输入如 "Q3 换 B"
```

### L5: 确认门控（保持现有 2 轮 Tab 交互）

L5 是最终确认，保持 ASCII 可视化多 Tab 展示。不需要方案卡。

---

## 交互次数对比

| 层级 | 当前(逐题) | 方案卡(批量) | 说明 |
|------|-----------|-------------|------|
| Phase 0 模式选择 | 1 次 | 1 次 | 不变 |
| L0 方向探索 | 2-3 次 | 2 次 | 方向+范围不可批量 |
| L1 核心识别 | 4-7 次 | **1 次** | 方案卡 |
| 代码扫描 | 0 次 | 0 次 | 自动(后台subagent) |
| L2 领域分支 | 5-12 次 | **1 次** | 方案卡 |
| L3 细节深入 | 5-12 次 | **1 次** | 方案卡 |
| L4 边界确认 | 4-7 次 | **1 次** | 方案卡 |
| L5 确认门控 | 2 次 | 2 次 | 不变 |
| **总计** | **23-44 次** | **9 次** | **减少 60-80%** |

**时间估算：**
- 当前: ~30-45 分钟（完整规划）
- 方案卡: ~8-12 分钟（完整规划）
- 功能开发模式: ~5-8 分钟（跳过 L2/L3）

---

## 修改指令解析规则

用户输入修改指令时，AI 需要解析以下格式：

| 用户输入 | 解析结果 |
|---------|---------|
| `Q3 换 B` | 第 3 题改为选项 B |
| `Q2 换 C, Q5 换 B` | 第 2 题改为 C，第 5 题改为 B |
| `第 3 个问题换成 B` | 同 Q3 换 B |
| `认证方式换成 Session` | 按关键词匹配到 Q3，选项匹配到 B |
| `Q4 我想用 MongoDB` | Q4 改为含 MongoDB 的选项 |
| `Q3 换 D, 并且补充一下: 需要支持微信登录` | Q3 改为 D + 自由文本补充 |

**解析优先级：**
1. 精确格式 `QN 换 X` → 直接替换
2. 关键词匹配 → 找到对应 Q 和选项
3. 无法匹配 → 追问一次确认（"你是指 Q3 认证方式吗？"）

---

## 快速修复模式的特殊处理

快速修复模式不走 L1-L4，但仍需确认 DT 任务列表。也改为方案卡：

```
【快速修复 — AI 方案卡】

基于: [用户描述] + [代码扫描]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

开发任务:
  DT-001: [任务描述] (文件: xxx)
  DT-002: [任务描述] (文件: xxx)
  DT-003: [任务描述] (文件: xxx)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

```json
{
  "options": [
    { "label": "确认执行 (推荐)", "description": "按以上任务列表生成 PRD 并开始" },
    { "label": "↓ 请在下方 Type something 输入修改", "description": "如 '去掉 DT-003' 或 '把 DT-001 拆成两个'" }
  ]
}
```

---

## Transform 模式的方案卡

Transform 模式的 T3 覆盖度分析后、T4 针对性问答，也改为方案卡：

```
【Transform T4 — AI 补充方案卡】

覆盖不足维度: §5 UI 设计 (PARTIAL), §6 业务规则 (SPARSE)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

§5 UI 设计补充:
Q1. 需要几个新页面?
  A) 2 个 ([页面1] + [页面2])  ← 从源 PRD Phase 描述推断
  B) 3 个 (加 [页面3])
  C) 我来列出
  → AI 选择: A

Q2. 关键页面布局
  A) 左右分栏 (列表+详情)  ← 匹配现有 viewer 模式
  B) 上下结构 (筛选+表格)
  C) Tab 切换
  → AI 选择: A

§6 业务规则补充:
Q3. 删除操作处理
  A) 软删除 (标记 is_deleted)  ← 数据安全
  B) 硬删除 + 弹窗确认
  C) 不允许删除
  → AI 选择: A

Q4. 权限粒度
  A) 基于角色 (admin/editor/viewer)  ← 源 PRD 提到角色
  B) 基于资源所有权 (仅创建者可编辑)
  C) 无权限控制
  → AI 选择: A

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
要修改请在下方 Type something 中输入如 "Q3 换 B"
```

---

## 与 DRAFT_2.md 的关系

DRAFT_2.md 解决的是**在哪里执行**（主对话 vs subagent + journal 持久化）。
DRAFT_3.md 解决的是**怎么问**（逐题 → 方案卡批量确认）。

两者互补：
- DRAFT_2 的 Q&A Journal 在方案卡模式下同样需要（每次方案卡确认后写入 journal）
- DRAFT_2 的 Subagent 架构不影响方案卡格式（subagent 内部也可以用方案卡与用户交互，或者方案卡只在主对话中使用）
- 叠加效果: 方案卡减少交互次数 60-80% + Journal 减少上下文占用 + Subagent 减少重活消耗

## 范围边界

### 要做的

**PyramidPRD SKILL.md:**
- L1-L4 每层的多个 AskUserQuestion 合并为 1 个方案卡格式
- 强制每题有 AI 推荐（推荐规则写入 skill 指令）
- 修改指令解析规则（`QN 换 X` 格式）
- 快速修复模式的 DT 方案卡
- Transform T4 的补充方案卡

### 不做的（YAGNI）

- 不改 L0 方向探索（战略决策需要 markdown 预览，不适合方案卡）
- 不改 L5 确认门控（ASCII 可视化已经是批量确认）
- 不改 Phase 0 模式选择
- 不做语音输入优化
- 不做方案卡的 Web UI 渲染优化（留给 viewer 后续迭代）

## 成功标准

- [ ] 完整规划模式交互次数 ≤ 10 次（当前 23-44 次）
- [ ] 每个方案卡的每个 Q 都有 AI 推荐标记
- [ ] 用户输入 "Q3 换 B" 能被正确解析并更新方案
- [ ] "全部接受" 是最常用路径，占 80%+ 使用量
- [ ] 非技术用户可以在 10 分钟内完成完整规划模式

## 开放问题

1. 方案卡中的选项数量：每题 2-4 个选项够不够？复杂需求可能需要更多选项，但选项太多又会让卡片太长。
2. 方案卡是否需要分业务题/技术题两个区域展示？还是混在一起（按逻辑顺序）？
3. 用户输入自由文本补充（如 "Q3 换 D, 补充：需要微信登录"）如何与结构化 journal 兼容？
4. 功能开发模式（跳过 L2/L3）是否还需要方案卡？只有 L1+L4 两张卡，感觉更像逐层问了。

---

> 下一步: 合并 DRAFT + DRAFT_2 + DRAFT_3，使用 `/botoolagent-pyramidprd` 生成统一的 arch-v2 PRD
