{
  "project": "PRD 对抗性审查 (PRD Adversarial Review)",
  "branchName": "botool/prd-adversarial-review",
  "description": "在 Stage 2 的两个关键节点（PRD 文档 + Enrich 产出）用 Codex CLI 做对抗性审查，通过 Codex↔Claude 全自动对抗循环（最多 3 轮）收敛，确保进入自动开发的输入质量",
  "prdFile": "tasks/prd-adversarial-review/prd.md",
  "constitution": {
    "rules": [
      {
        "id": "rule-001",
        "name": "状态管理规范",
        "category": "application",
        "file": "rules/application/状态管理规范.md",
        "checklist": [
          "React Context 用于全局共享状态",
          "localStorage 通过 scopedKey() 添加 workspace 前缀",
          "SSR 安全: localStorage 访问在 useEffect 中",
          "浏览器 API 组件标记 'use client'",
          "流式数据使用 SSE + ReadableStream reader"
        ]
      },
      {
        "id": "rule-002",
        "name": "项目结构规范",
        "category": "application",
        "file": "rules/application/项目结构规范.md",
        "checklist": [
          "API 路由放在 src/app/api/{feature}/route.ts",
          "组件放 components/ 目录 PascalCase 命名",
          "Hook 放 hooks/ 以 use 前缀命名",
          "lib/ 放纯工具函数无 React 依赖",
          "新文件后更新对应 barrel index.ts"
        ]
      },
      {
        "id": "rule-003",
        "name": "API设计规范",
        "category": "backend",
        "file": "rules/backend/API设计规范.md",
        "checklist": [
          "route.ts 放在 api/{feature}/ 下",
          "handler 用 try/catch 包裹",
          "错误返回 { error: string } + 对应状态码",
          "SSE 响应设置正确 Content-Type headers",
          "spawn 必须移除 CLAUDECODE 环境变量",
          "输入校验在 handler 顶部完成",
          "写入文件前确保目录存在"
        ]
      },
      {
        "id": "rule-004",
        "name": "前端测试规范",
        "category": "frontend",
        "file": "rules/frontend/测试.md",
        "checklist": [
          "E2E 测试使用 Playwright",
          "每个关键组件有对应测试用例",
          "5 阶段核心流程需 E2E 覆盖",
          "避免 sleep/固定等待用条件等待"
        ]
      },
      {
        "id": "rule-005",
        "name": "命名规范",
        "category": "frontend",
        "file": "rules/frontend/命名规范.md",
        "checklist": [
          "组件 PascalCase 文件名与导出名一致",
          "Props 接口 {ComponentName}Props 格式",
          "Hook 用 use 前缀 camelCase",
          "布尔变量 is/has/should 前缀",
          "类型导出使用 export type 与值分离"
        ]
      },
      {
        "id": "rule-006",
        "name": "样式规范",
        "category": "frontend",
        "file": "rules/frontend/样式规范.md",
        "checklist": [
          "按钮黑底白字 bg-neutral-900 text-white",
          "彩色仅用于状态 Badge 不用于按钮",
          "弹窗/下拉框必须白色背景 bg-white",
          "使用 Tailwind 工具类禁止自定义 CSS",
          "圆角 rounded-lg 边框 border-neutral-200"
        ]
      },
      {
        "id": "rule-007",
        "name": "测试用例规范",
        "category": "testing",
        "file": "rules/testing/测试用例规范.md",
        "checklist": [
          "每个 API 至少一个正常+一个错误路径测试",
          "测试文件 .spec.ts TypeScript 格式",
          "优先用 Playwright 内置断言",
          "Typecheck 必须通过 npx tsc --noEmit"
        ]
      }
    ],
    "ruleAuditSummary": ""
  },
  "devTasks": [
    {
      "id": "DT-001",
      "title": "创建 /api/prd/review API 路由",
      "prdSection": "7.1 (L413-447)",
      "priority": 1,
      "passes": true,
      "dependsOn": [],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "cd viewer && npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "Review API route file exists",
          "command": "test -f viewer/src/app/api/prd/review/route.ts",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        { "type": "typecheck", "desc": "TypeScript 编译通过" },
        { "type": "unit", "desc": "Codex exec 两步法调用与解析", "tdd": true },
        { "type": "unit", "desc": "fail-closed: 解析失败 vs 合法空结果", "tdd": true }
      ],
      "steps": [
        { "action": "create", "file": "viewer/src/app/api/prd/review/route.ts", "description": "创建 API 路由文件" },
        { "action": "implement", "description": "实现 Codex exec 两步法（spawn + 自由文本解析为 ReviewFinding[]）+ 规范审查合并 + SSE 流式响应 + 60s 超时 + fail-closed" },
        { "action": "verify", "command": "cd viewer && npx tsc --noEmit", "expected": "exit 0" },
        { "action": "commit", "message": "feat: DT-001 - add /api/prd/review route with Codex exec two-step method" }
      ]
    },
    {
      "id": "DT-002",
      "title": "创建 /api/prd/fix API 路由",
      "prdSection": "7.1 (L413-447)",
      "priority": 2,
      "passes": true,
      "dependsOn": [],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "cd viewer && npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "Fix API route file exists",
          "command": "test -f viewer/src/app/api/prd/fix/route.ts",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        { "type": "typecheck", "desc": "TypeScript 编译通过" },
        { "type": "unit", "desc": "Claude API 修正调用与 SSE 响应", "tdd": true }
      ],
      "steps": [
        { "action": "create", "file": "viewer/src/app/api/prd/fix/route.ts", "description": "创建 API 路由文件" },
        { "action": "implement", "description": "实现 Claude API 调用（PRD 修正 prompt + Enrich 修正 prompt）+ SSE 流式响应" },
        { "action": "verify", "command": "cd viewer && npx tsc --noEmit", "expected": "exit 0" },
        { "action": "commit", "message": "feat: DT-002 - add /api/prd/fix route with Claude API" }
      ]
    },
    {
      "id": "DT-003",
      "title": "创建 AdversarialReviewStep 组件",
      "prdSection": "7.2 (L448-487)",
      "priority": 3,
      "passes": true,
      "dependsOn": ["DT-001", "DT-002"],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "cd viewer && npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "Component file exists",
          "command": "test -f viewer/src/components/pipeline/AdversarialReviewStep.tsx",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        { "type": "typecheck", "desc": "TypeScript 编译通过" },
        { "type": "e2e", "desc": "组件渲染进度条和 findings 统计" }
      ],
      "steps": [
        { "action": "create", "file": "viewer/src/components/pipeline/AdversarialReviewStep.tsx", "description": "创建组件文件" },
        { "action": "implement", "description": "实现 SSE 客户端 + 进度条 + TerminalActivityFeed + findings 统计 Badge + 状态 Badge (PASSED/ACKNOWLEDGED/SKIPPED) + ruleAuditSummary 提取" },
        { "action": "verify", "command": "cd viewer && npx tsc --noEmit", "expected": "exit 0" },
        { "action": "commit", "message": "feat: DT-003 - add AdversarialReviewStep component" }
      ]
    },
    {
      "id": "DT-004",
      "title": "重构 Stage 2 页面步骤编排",
      "prdSection": "7.2 (L448-487)",
      "priority": 4,
      "passes": true,
      "dependsOn": ["DT-003"],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "cd viewer && npx tsc --noEmit",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        { "type": "typecheck", "desc": "TypeScript 编译通过" },
        { "type": "e2e", "desc": "Stage 2 页面 5 步流水线完整走通" }
      ],
      "steps": [
        { "action": "modify", "file": "viewer/src/app/stage2/page.tsx", "description": "将 3 步扩展为 5 步: Step 0 规则选择 → Step 1 PRD审查 → Step 2 AutoEnrich → Step 3 Enrich审查 → Step 4 汇总" },
        { "action": "implement", "description": "更新 currentStep 状态管理(0-4), PipelineProgress 标签(5步), 数据传递链(selectedRuleIds→fixedPrd+ruleAuditSummary→enrichResult→fixedEnrich→summary)" },
        { "action": "verify", "command": "cd viewer && npx tsc --noEmit", "expected": "exit 0" },
        { "action": "commit", "message": "feat: DT-004 - refactor Stage 2 to 5-step pipeline with adversarial review" }
      ]
    },
    {
      "id": "DT-005",
      "title": "实现对抗循环编排逻辑",
      "prdSection": "7.3 (L488-519)",
      "priority": 5,
      "passes": true,
      "dependsOn": ["DT-001", "DT-002"],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "cd viewer && npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "Adversarial loop module exists",
          "command": "test -f viewer/src/lib/adversarial-loop.ts",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        { "type": "typecheck", "desc": "TypeScript 编译通过" },
        { "type": "unit", "desc": "状态机所有转换路径: passed, acknowledged, skipped", "tdd": true },
        { "type": "unit", "desc": "findings 累计跨轮次不丢失", "tdd": true },
        { "type": "unit", "desc": "Codex 失败重试 1 次后 skipped", "tdd": true }
      ],
      "steps": [
        { "action": "create", "file": "viewer/src/lib/adversarial-loop.ts", "description": "创建对抗循环模块" },
        { "action": "implement", "description": "实现 runAdversarialLoop(): 状态机 IDLE→REVIEWING→FIXING→PASSED/ACKNOWLEDGED/SKIPPED, 收敛条件 HIGH=0+MEDIUM=0, 最多 3 轮, retry 1 次, findings 累计, onProgress 回调" },
        { "action": "verify", "command": "cd viewer && npx tsc --noEmit", "expected": "exit 0" },
        { "action": "commit", "message": "feat: DT-005 - implement adversarial loop state machine" }
      ]
    },
    {
      "id": "DT-006",
      "title": "实现审查结果持久化",
      "prdSection": "7.3 (L488-519)",
      "priority": 6,
      "passes": true,
      "dependsOn": ["DT-005"],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "cd viewer && npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "Review save API route file exists",
          "command": "test -f viewer/src/app/api/prd/review-save/route.ts",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        { "type": "typecheck", "desc": "TypeScript 编译通过" },
        { "type": "unit", "desc": "projectId 白名单校验拒绝路径穿越", "tdd": true },
        { "type": "unit", "desc": "PRD 备份 + 原子替换写入", "tdd": true }
      ],
      "steps": [
        { "action": "create", "file": "viewer/src/app/api/prd/review-save/route.ts", "description": "创建持久化 API 路由" },
        { "action": "implement", "description": "实现 projectId 白名单 /^[a-zA-Z0-9_-]+$/ + realpath 校验 + prd.md 备份(prd-{timestamp}.md.bak) + 临时文件 + fs.rename 原子替换 + reviewResult JSON 写入" },
        { "action": "verify", "command": "cd viewer && npx tsc --noEmit", "expected": "exit 0" },
        { "action": "commit", "message": "feat: DT-006 - add review-save API with path safety and atomic write" }
      ]
    },
    {
      "id": "DT-007",
      "title": "创建 botoolagent-prdreview CLI Skill",
      "prdSection": "7.4 (L520-547)",
      "priority": 7,
      "passes": true,
      "dependsOn": ["DT-001"],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "SKILL.md file exists",
          "command": "test -f skills/BotoolAgent/PRDReview/SKILL.md",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        { "type": "manual", "desc": "SKILL.md frontmatter 格式校验 + symlink 存在性检查" },
        { "type": "manual", "desc": "CLI 触发词测试: /botoolagent-prdreview" }
      ],
      "steps": [
        { "action": "create", "file": "skills/BotoolAgent/PRDReview/SKILL.md", "description": "创建 SKILL.md 含 frontmatter (name, description, user-invocable, trigger words)" },
        { "action": "implement", "description": "实现两步法审查流程指引 + 对抗循环 (Claude 修正 → Codex 再审) + 终端输出 + prd-review.json 保存" },
        { "action": "verify", "command": "test -f skills/BotoolAgent/PRDReview/SKILL.md && echo 'SKILL exists'", "expected": "exit 0" },
        { "action": "commit", "message": "feat: DT-007 - add botoolagent-prdreview CLI skill" }
      ]
    },
    {
      "id": "DT-008",
      "title": "修复 Enrich codeExamples 全局分配 Bug",
      "prdSection": "7.4 (L520-547)",
      "priority": 8,
      "passes": true,
      "dependsOn": [],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "cd viewer && npx tsc --noEmit",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        { "type": "typecheck", "desc": "TypeScript 编译通过" },
        { "type": "unit", "desc": "codeExamples 按 taskId 正确分配到对应任务", "tdd": true }
      ],
      "steps": [
        { "action": "modify", "file": "viewer/src/app/api/prd/merge/route.ts", "description": "修改 mergeEnrichedPrdJson() 按 codeExample.taskId 过滤分配" },
        { "action": "modify", "file": "viewer/src/app/api/prd/enrich/route.ts", "description": "更新 enrich prompt 要求每个 codeExample 包含 taskId 字段" },
        { "action": "verify", "command": "cd viewer && npx tsc --noEmit", "expected": "exit 0" },
        { "action": "commit", "message": "fix: DT-008 - filter codeExamples by taskId instead of global assignment" }
      ]
    }
  ],
  "sessions": [
    {
      "id": "S1",
      "tasks": ["DT-001", "DT-002"],
      "reason": "Phase 1 API 基础设施，两个独立 API 端点，后续任务的前置依赖"
    },
    {
      "id": "S2",
      "tasks": ["DT-003", "DT-004", "DT-005"],
      "reason": "Phase 2+3 核心组件和循环逻辑，DT-004 依赖 DT-003，DT-005 依赖 S1 的 API"
    },
    {
      "id": "S3",
      "tasks": ["DT-006", "DT-007", "DT-008"],
      "reason": "Phase 3+4 收尾: 持久化(DT-006依赖DT-005) + CLI Skill + Bug修复(独立)"
    }
  ]
}
