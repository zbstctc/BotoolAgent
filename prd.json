{
  "project": "BotoolAgent",
  "branchName": "botool/stage3-cockpit",
  "description": "Stage 3 Cockpit 重设计 — 将中间区域从静态流程图替换为批次面板（Agent Teams 并行卡片）+ 批次时间线双层结构，清晰展示 Lead Agent → Teammate 的并行派遣和实时进度，并提供完整时间维度信息（已运行时间、均速、ETA、每任务耗时）",
  "prdFile": "tasks/stage3-cockpit/prd.md",
  "constitution": {
    "rules": [
      {
        "id": "rule-001",
        "name": "状态管理规范",
        "category": "application",
        "content": "# 应用状态管理规范\n\n## 状态层级\n1. **React Context**（全局共享状态）：项目列表、活跃项目、workspace\n2. **localStorage**（持久化）：通过 `lib/project-storage.ts` 和 `lib/prd-session-storage.ts` 管理\n3. **组件 state**（局部状态）：表单输入、UI 开关、临时数据\n4. **URL params**（路由状态）：sessionId、projectId、mode\n\n## Context 使用模式\n```typescript\n// 定义\nconst MyContext = createContext<ContextValue | null>(null);\n\n// Provider\nexport function MyProvider({ children }: { children: React.ReactNode }) {\n  const [state, setState] = useState(initialValue);\n  return <MyContext.Provider value={{ state, setState }}>{children}</MyContext.Provider>;\n}\n\n// Hook（必须包含 null check）\nexport function useMy(): ContextValue {\n  const context = useContext(MyContext);\n  if (!context) throw new Error('useMy must be used within MyProvider');\n  return context;\n}\n```\n\n## localStorage 存储\n- 所有 key 必须通过 `scopedKey()` 添加 workspace 前缀，支持多工作区隔离\n- 读取时检查 `typeof window === 'undefined'` 防止 SSR 错误\n- 写入使用 debounce（500ms）避免频繁 IO\n- 数据结构包含 `version` 字段以便未来迁移\n\n## 数据获取模式\n- 短请求：`fetch()` + `useState` + `useEffect`\n- 长轮询：自定义 hook（如 `useAgentStatus`）内 `setInterval`\n- 流式数据：SSE（`text/event-stream`） + `ReadableStream` reader\n- CLI 交互：`useCliChat` hook 管理双向流\n\n## SSR 安全\n- `localStorage`/`sessionStorage` 访问必须在 `useEffect` 或条件判断 `typeof window !== 'undefined'` 中\n- 所有使用浏览器 API 的组件必须标记 `'use client'`\n"
      },
      {
        "id": "rule-002",
        "name": "项目结构规范",
        "category": "application",
        "content": "# 项目结构规范\n\n## 目录结构\n```\nviewer/src/\n├── app/                   # Next.js App Router\n│   ├── api/               # API 路由（服务端）\n│   │   ├── {feature}/route.ts\n│   │   └── {feature}/[id]/route.ts\n│   ├── stage{1-5}/page.tsx  # 5 阶段页面\n│   ├── page.tsx           # Dashboard 首页\n│   ├── layout.tsx         # 根布局（含 Provider）\n│   └── globals.css        # 全局样式 + 自定义动画\n├── components/            # UI 组件\n│   ├── {Component}.tsx    # 独立组件\n│   ├── {domain}/          # 领域组件子目录\n│   │   ├── {Component}.tsx\n│   │   └── index.ts       # barrel export\n│   └── index.ts           # 总 barrel export\n├── contexts/              # React Context\n│   └── {Name}Context.tsx\n├── hooks/                 # 自定义 Hooks\n│   ├── use{Feature}.ts\n│   └── index.ts\n└── lib/                   # 工具库（服务端 + 客户端共用）\n    ├── project-root.ts    # 路径工具（服务端）\n    ├── tool-types.ts      # 共享类型定义\n    ├── cli-manager.ts     # Claude CLI 管理\n    └── {feature}.ts       # 功能模块\n```\n\n## 文件职责\n- **page.tsx**：页面入口，组合组件，管理页面级状态\n- **components/**：纯 UI 逻辑，通过 props 接收数据\n- **hooks/**：可复用的状态逻辑，不包含 UI\n- **lib/**：纯工具函数，无 React 依赖（除类型定义）\n- **contexts/**：全局共享状态\n\n## 新文件规则\n- 新组件先检查 `components/` 是否有可复用的\n- 新 API 遵循 RESTful 命名：`/api/{资源名}/{动作}`\n- 新 hook 必须以 `use` 前缀命名，放在 `hooks/` 目录\n- 新建文件后必须更新对应的 barrel `index.ts`\n\n## 技术栈版本\n- Next.js 16+ (App Router)\n- React 19+\n- TypeScript 5+ (strict mode)\n- Tailwind CSS 4+\n- Playwright（E2E 测试）\n"
      },
      {
        "id": "rule-003",
        "name": "API设计规范",
        "category": "backend",
        "content": "# API 设计规范\n\n## 路由结构（Next.js App Router）\n- 路由文件固定为 `route.ts`，放在 `src/app/api/{feature}/` 下\n- 嵌套资源使用子目录：`/api/prd/[id]/route.ts`、`/api/prd/save/route.ts`\n- 动态参数使用 `[param]` 目录名\n\n## HTTP 方法\n- `GET`：查询/列表\n- `POST`：创建/执行操作\n- `DELETE`：删除资源\n- 导出格式：`export async function GET(request: NextRequest) { ... }`\n\n## 请求解析\n- JSON body：`const body = await request.json()`\n- Query params：`const searchParams = request.nextUrl.searchParams; searchParams.get('key')`\n- 路径参数：`{ params }: { params: Promise<{ id: string }> }` 然后 `const { id } = await params`\n\n## 响应格式\n- 成功：`NextResponse.json({ data })` 或 `NextResponse.json({ success: true, ... })`\n- 错误：`NextResponse.json({ error: '描述' }, { status: 4xx/5xx })`\n- 流式：`new Response(stream, { headers: { 'Content-Type': 'text/event-stream', 'Cache-Control': 'no-cache' } })`\n\n## 状态码\n- `200`：成功（`NextResponse.json()` 默认）\n- `201`：创建成功\n- `400`：参数错误（缺失必填字段、格式不合法）\n- `404`：资源不存在\n- `409`：冲突（如 Agent 已在运行）\n- `500`：服务器错误\n\n## 错误处理\n- 每个 handler 用 try/catch 包裹\n- `catch` 中记录 `console.error()`，返回通用错误消息\n- 禁止在错误响应中暴露内部路径或堆栈信息\n- 输入校验在 handler 顶部完成，不合法立即 return 400\n\n## SSE 流式响应模式\n```typescript\nconst encoder = new TextEncoder();\nlet controller: ReadableStreamDefaultController | null = null;\n\nconst stream = new ReadableStream({\n  start(c) { controller = c; },\n  cancel() { /* cleanup */ }\n});\n\n// 发送数据\ncontroller?.enqueue(encoder.encode(`data: ${JSON.stringify(payload)}\\n\\n`));\n// 结束\ncontroller?.close();\n\nreturn new Response(stream, {\n  headers: {\n    'Content-Type': 'text/event-stream',\n    'Cache-Control': 'no-cache',\n    Connection: 'keep-alive',\n  },\n});\n```\n\n## 子进程 spawn 规范\n- 必须移除 `CLAUDECODE` 环境变量防止嵌套 session 错误\n  ```typescript\n  const { CLAUDECODE: _, ...cleanEnv } = process.env;\n  ```\n- 长时间运行的进程使用 `detached: true` + `child.unref()`\n- PID 写入 `.state/agent-pid` 文件用于进程管理\n\n## 文件系统操作\n- 使用 `@/lib/project-root` 中的路径函数获取绝对路径\n- 检查文件存在用 `fs.existsSync()`，读取用 `fs.readFileSync(path, 'utf-8')`\n- 写入文件前确保目录存在（`mkdir -p`）\n"
      },
      {
        "id": "rule-004",
        "name": "前端测试规范",
        "category": "frontend",
        "content": "# 前端测试规范\n\n## 测试框架\n- E2E 测试使用 Playwright（配置文件：`playwright.config.ts`）\n- 测试文件放在 `tests/` 目录，以 `.spec.ts` 结尾\n\n## 组件测试\n- 每个关键组件应有对应的测试用例\n- 测试文件命名：`{ComponentName}.spec.ts`\n- 覆盖：正常渲染、交互行为、边界状态（loading、error、empty）\n\n## E2E 测试要求\n- 关键用户流程必须有 E2E 测试覆盖\n- 5 阶段工作流（Stage 1-5）各自的核心路径\n- 测试应独立运行，不依赖其他测试的状态\n\n## 页面测试清单\n- Dashboard：项目列表渲染、新建项目、导入 PRD\n- Stage 1：问答交互、PRD 预览、保存\n- Stage 2：规范选择、PRD 转 JSON\n- Stage 3：Agent 启动/停止、状态轮询\n- Stage 5：合并操作\n\n## 断言规范\n- 使用 Playwright 的 `expect()` 断言\n- 页面导航后等待元素出现（`waitForSelector`）\n- 网络请求验证使用 `page.waitForResponse()`\n"
      },
      {
        "id": "rule-005",
        "name": "前端命名规范",
        "category": "frontend",
        "content": "# 前端命名规范\n\n## 组件命名\n- 使用 PascalCase 命名组件文件和导出名（`ProjectCard.tsx` → `export function ProjectCard()`）\n- 文件名与组件名保持一致\n- 复合组件放在同名子目录中（`pyramid/PyramidNavigation.tsx`、`pipeline/RuleCheckStep.tsx`）\n- 使用 barrel exports（`index.ts`）统一导出\n\n## Props 接口命名\n- Props 接口使用 `{ComponentName}Props` 格式（如 `StageIndicatorProps`、`PRDPreviewProps`）\n- 在组件文件内定义，使用 `export interface`\n- 若 Props 简单（2-3 个属性），可用内联解构\n\n## Hooks 命名\n- 统一使用 `use` 前缀 + camelCase（`useCliChat`、`useAgentStatus`、`useFileWatcher`）\n- 文件名与 hook 名一致（`useCliChat.ts`）\n- 通过 `hooks/index.ts` 统一导出\n\n## Context 命名\n- Context 使用 PascalCase（`ProjectContext`）\n- Provider 使用 `{Name}Provider`（`ProjectProvider`）\n- 消费 hook 使用 `use{Name}`（`useProject`）\n\n## 变量命名\n- 变量和函数使用 camelCase（`currentLevel`、`handleSubmitAnswers`）\n- 常量使用 UPPER_CASE（`PROJECT_ROOT`、`STATUS_FILE`）\n- 布尔变量使用 `is/has/should` 前缀（`isLoading`、`hasRestoredStateRef`、`saveSuccess`）\n\n## TypeScript 类型\n- 对象形状使用 `interface`（首选）\n- 联合类型使用 `type`（如 `type PipelineMode = 'quick' | 'feature' | 'full' | 'transform'`）\n- 类型守卫使用 `is{TypeName}` 命名（如 `isAskUserQuestionInput()`）\n- 类型导出使用 `export type { ... }` 与值导出分离\n\n## Barrel Exports 规范\n```typescript\n// components/index.ts\nexport { Header } from \"./Header\";\nexport type { HeaderProps } from \"./Header\";\nexport { ProjectCard } from \"./ProjectCard\";\n```\n- 每个目录的 `index.ts` 导出该目录的所有公共组件和类型\n- 子目录（如 `pyramid/`、`pipeline/`）各自维护 barrel\n"
      },
      {
        "id": "rule-006",
        "name": "前端样式规范",
        "category": "frontend",
        "content": "# 前端样式规范\n\n## 设计理念：岩石色系 (Rock Palette)\n- **整体风格**：黑白灰为主的单色系，沉稳、专业、克制\n- **按钮全部黑色**：主按钮用黑底白字，不使用蓝色/紫色等彩色按钮\n- **彩色仅用于状态指示**：成功(绿)、错误(红)、警告(琥珀)、进行中(蓝) — 只用在小元素（徽章、圆点、状态灯），不用在按钮上\n- **禁用彩色按钮**：`bg-blue-600`、`bg-purple-600`、`bg-indigo-600` 等彩色按钮一律禁止\n\n## Tailwind CSS 优先\n- 所有样式必须使用 Tailwind 工具类，禁止自定义 CSS（除 `globals.css` 中的动画定义）\n- 不使用 CSS Modules 或 styled-components\n\n## 调色板\n\n### 主色系：neutral（唯一主色系）\n| 用途 | 色值 | Tailwind 类 |\n|------|------|-------------|\n| 纯黑（按钮、标题） | `#171717` | `neutral-900` |\n| 深灰（正文） | `#525252` | `neutral-600` |\n| 中灰（辅助文字） | `#737373` | `neutral-500` |\n| 浅灰（提示、placeholder） | `#a3a3a3` | `neutral-400` |\n| 边框 | `#e5e5e5` | `neutral-200` |\n| 浅底色 | `#f5f5f5` | `neutral-100` |\n| 背景 | `#fafafa` | `neutral-50` |\n\n### 文本层级\n- 一级标题/重要内容：`text-neutral-900`\n- 正文：`text-neutral-600`\n- 辅助说明：`text-neutral-500`\n- 提示/placeholder：`text-neutral-400`\n\n### 状态色（仅用于小元素，不用于按钮）\n| 状态 | 用途 | 徽章/标签 | 圆点/状态灯 | 背景提示框 |\n|------|------|-----------|-------------|------------|\n| 成功 | 完成、通过 | `bg-green-100 text-green-700` | `bg-green-500` | `bg-green-50 border-green-200 text-green-700` |\n| 错误 | 失败、异常 | `bg-red-100 text-red-700` | `bg-red-500` | `bg-red-50 border-red-200 text-red-600` |\n| 警告 | 注意 | `bg-amber-100 text-amber-700` | `bg-amber-500` | `bg-amber-50 border-amber-200 text-amber-700` |\n| 进行中 | 活跃、加载 | `bg-neutral-200 text-neutral-700` | `bg-neutral-500` | `bg-neutral-100 border-neutral-200 text-neutral-600` |\n\n> **注意**：`bg-blue-100 text-blue-700` 等蓝色标签应迁移为 `bg-neutral-200 text-neutral-700`\n\n## 按钮样式\n\n### 主按钮（黑底白字）— 唯一的 CTA 按钮\n```\nbg-neutral-900 text-white hover:bg-neutral-800\ndisabled:bg-neutral-300 disabled:text-neutral-500 disabled:cursor-not-allowed\n```\n适用：保存、提交、确认、开始、创建、下一步\n\n### 次按钮（白底黑框）\n```\nborder border-neutral-300 text-neutral-700 bg-white\nhover:bg-neutral-50 hover:border-neutral-400\ndisabled:bg-neutral-100 disabled:text-neutral-400 disabled:cursor-not-allowed\n```\n适用：取消、返回、辅助操作\n\n### 危险按钮（红色 — 唯一允许的彩色按钮）\n```\nbg-red-600 text-white hover:bg-red-700\ndisabled:bg-red-300 disabled:cursor-not-allowed\n```\n适用：删除、停止、终止（需要用户特别注意的破坏性操作）\n\n### 幽灵按钮（无边框）\n```\ntext-neutral-600 hover:text-neutral-900 hover:bg-neutral-100\n```\n适用：关闭、折叠、次要链接\n\n### 统一基础类\n```\npx-4 py-2 rounded-lg font-medium text-sm transition-colors\n```\n\n### 禁止使用的按钮配色\n- ~~`bg-blue-600 text-white`~~ → 改用 `bg-neutral-900 text-white`\n- ~~`bg-purple-600 text-white`~~ → 改用 `bg-neutral-900 text-white`\n- ~~`bg-indigo-600 text-white`~~ → 改用 `bg-neutral-900 text-white`\n- ~~`bg-green-600 text-white`~~ (作为按钮时) → 改用 `bg-neutral-900 text-white`\n\n## 圆角与阴影\n- 常规容器：`rounded-lg`\n- 小元素（badge、tag）：`rounded-md`\n- 圆形（头像、状态灯）：`rounded-full`\n- 卡片阴影：`shadow-sm`（普通）、`shadow-xl`（弹窗/Modal）\n\n## 边框\n- 默认边框：`border border-neutral-200`\n- 强调边框：`border-2 border-neutral-900`\n- 激活状态：`ring-2 ring-neutral-200 border-neutral-400`\n\n## 交互状态\n- Hover：`hover:bg-neutral-50`、`hover:border-neutral-300`、`hover:shadow-sm`\n- Focus：`focus:border-neutral-900 focus:ring-2 focus:ring-neutral-200 outline-none`\n- Disabled：`disabled:bg-neutral-200 disabled:text-neutral-400 disabled:cursor-not-allowed`\n- Active/pressed：`active:bg-neutral-800`\n\n## 布局\n- 使用 Flex 布局为主（`flex items-center justify-between`）\n- 容器宽度约束：`max-w-7xl mx-auto`\n- 间距使用 `gap-2`、`gap-3`、`gap-4`\n- 内边距：`p-4`、`px-6 py-4`\n\n## 弹窗/对话框（重要）\n- 所有弹窗和下拉框必须使用白色背景（`bg-white`），严禁透明\n- 遮罩层：`bg-black/50`\n- 弹窗容器：`bg-white rounded-lg shadow-xl`\n\n## 图标\n- 使用内联 SVG，不使用图标库\n- 标准尺寸：`w-4 h-4`（小）、`w-5 h-5`（中）、`w-6 h-6`（大）\n- 颜色继承：`stroke=\"currentColor\"` 或 `fill=\"currentColor\"`\n- 线宽统一：`strokeWidth={2}`\n\n## 过渡动画\n- 颜色变化：`transition-colors`\n- 所有属性：`transition-all`\n- 自定义动画定义在 `globals.css`，类名前缀 `task-card-`\n\n## 迁移对照表（快速查找替换）\n| 旧用法 | 新用法 | 备注 |\n|--------|--------|------|\n| `bg-blue-600 text-white hover:bg-blue-700` | `bg-neutral-900 text-white hover:bg-neutral-800` | 主按钮 |\n| `bg-purple-600 text-white hover:bg-purple-700` | `bg-neutral-900 text-white hover:bg-neutral-800` | 主按钮 |\n| `bg-green-600 text-white hover:bg-green-700` | `bg-neutral-900 text-white hover:bg-neutral-800` | 确认按钮 |\n| `disabled:bg-blue-300` | `disabled:bg-neutral-300 disabled:text-neutral-500` | 禁用态 |\n| `bg-blue-50 text-blue-600 border-blue-200` | `bg-neutral-100 text-neutral-700 border-neutral-200` | 信息提示框 |\n| `bg-blue-100 text-blue-700` | `bg-neutral-200 text-neutral-700` | 标签/徽章 |\n| `border-2 border-blue-500` | `border-2 border-neutral-900` | 强调边框 |\n| `ring-2 ring-blue-100 border-blue-300` | `ring-2 ring-neutral-200 border-neutral-400` | 激活态 |\n| `focus:border-blue-500 focus:ring-blue-200` | `focus:border-neutral-900 focus:ring-neutral-200` | 聚焦态 |\n| `bg-purple-100 text-purple-700` | `bg-neutral-200 text-neutral-700` | 标签 |\n| `bg-indigo-100 text-indigo-600` | `bg-neutral-200 text-neutral-700` | 图标背景 |\n"
      },
      {
        "id": "rule-007",
        "name": "测试用例规范",
        "category": "testing",
        "content": "# 测试用例规范\n\n## 测试命名\n- 使用 `describe` 描述测试套件（模块/功能名）\n- 使用 `it` 或 `test` 描述具体行为（\"should ...\"）\n- 文件命名：`{feature}.spec.ts`\n\n## 测试覆盖要求\n- 单元测试覆盖率 > 80%\n- 每个 API 端点至少一个正常路径 + 一个错误路径测试\n- 关键用户流程必须有 E2E 测试\n\n## E2E 测试（Playwright）\n- 配置文件：`playwright.config.ts`\n- 测试目录：`tests/`\n- 每个 Stage 的核心流程需覆盖：\n  - Stage 1：模式选择 → 问答 → PRD 生成 → 保存\n  - Stage 2：规范选择 → PRD 转 JSON\n  - Stage 3：Agent 启动 → 状态监控 → Agent 停止\n  - Stage 5：代码审查 → 合并\n\n## API 测试模式\n```typescript\ndescribe('POST /api/prd/save', () => {\n  it('should save PRD content and return id', async () => {\n    const response = await fetch('/api/prd/save', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ content: '# PRD: Test' }),\n    });\n    expect(response.ok).toBe(true);\n    const data = await response.json();\n    expect(data.id).toBeDefined();\n  });\n\n  it('should return 400 for empty content', async () => {\n    const response = await fetch('/api/prd/save', {\n      method: 'POST',\n      body: JSON.stringify({ content: '' }),\n    });\n    expect(response.status).toBe(400);\n  });\n});\n```\n\n## 测试数据\n- 使用固定的测试数据，不依赖外部服务\n- 测试 PRD 内容使用 `# PRD: Test Project` 格式\n- 清理：测试完成后删除测试生成的文件\n\n## 断言规范\n- 优先使用 Playwright 内置断言（`expect(page.locator(...)).toBeVisible()`）\n- 网络请求断言：`page.waitForResponse(url => url.includes('/api/...'))`\n- 避免 `sleep`/固定等待，使用条件等待\n\n## TypeScript 规范\n- 测试文件使用 TypeScript（`.spec.ts`），不使用 `.spec.js`\n- 测试中的类型导入：`import type { ... } from '@/lib/tool-types'`\n- Typecheck 必须通过：`npx tsc --noEmit`\n"
      }
    ],
    "ruleAuditSummary": ""
  },
  "devTasks": [
    {
      "id": "DT-001",
      "title": "增强进度带组件 (ProgressStrip)",
      "prdSection": "7.1 (L510-535)",
      "priority": 1,
      "passes": true,
      "dependsOn": [],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "ProgressStrip.tsx exists",
          "command": "test -f viewer/src/components/ProgressStrip.tsx",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        {
          "type": "typecheck",
          "desc": "TypeScript 编译通过"
        },
        {
          "type": "unit",
          "desc": "ETA 计算和三种状态切换（未运行/运行中/完成）逻辑",
          "tdd": true
        }
      ]
    },
    {
      "id": "DT-002",
      "title": "Teammate 状态 Hook + 数据基础设施 (useTeammates)",
      "prdSection": "7.1 (L510-535)",
      "priority": 2,
      "passes": true,
      "dependsOn": [],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "useTeammates.ts exists",
          "command": "test -f viewer/src/hooks/useTeammates.ts",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        {
          "type": "typecheck",
          "desc": "TypeScript 编译通过"
        },
        {
          "type": "unit",
          "desc": "teammates.json 解析、updatedAt 过期检测、prd.json 拓扑排序 fallback、useMemo 缓存",
          "tdd": true
        }
      ]
    },
    {
      "id": "DT-003",
      "title": "任务耗时推算 Hook (useTaskTimings)",
      "prdSection": "7.2 (L536-568)",
      "priority": 3,
      "passes": true,
      "dependsOn": [
        "DT-002"
      ],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "useTaskTimings.ts exists",
          "command": "test -f viewer/src/hooks/useTaskTimings.ts",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        {
          "type": "typecheck",
          "desc": "TypeScript 编译通过"
        },
        {
          "type": "unit",
          "desc": "多数据源时间融合（teammates优先/progressLog次选/均分fallback）、批次分组、currentTaskElapsed 每秒更新",
          "tdd": true
        }
      ]
    },
    {
      "id": "DT-006",
      "title": "统计区 + 实时活动日志 (LiveLog + AgentDataPanel 增强)",
      "prdSection": "7.2 (L536-568)",
      "priority": 4,
      "passes": true,
      "dependsOn": [],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "LiveLog.tsx exists",
          "command": "test -f viewer/src/components/LiveLog.tsx",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        {
          "type": "typecheck",
          "desc": "TypeScript 编译通过"
        },
        {
          "type": "e2e",
          "desc": "统计区（均耗时/代码变更/文件数/提交数/ETA）和实时活动日志在浏览器中正确渲染"
        },
        {
          "type": "manual",
          "desc": "Agent 运行中验证：git 数据自动轮询（不等待 tab 激活），LiveLog 自动滚动"
        }
      ]
    },
    {
      "id": "DT-007",
      "title": "Tab 重排序 + 流程图降级",
      "prdSection": "7.2 (L536-568)",
      "priority": 5,
      "passes": true,
      "dependsOn": [],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "npx tsc --noEmit",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        {
          "type": "typecheck",
          "desc": "TypeScript 编译通过"
        },
        {
          "type": "e2e",
          "desc": "Tab 顺序正确：文件变更 | 提交记录 | 流程图ℹ️，默认激活文件变更 tab"
        },
        {
          "type": "manual",
          "desc": "进度日志 tab 已移除；流程图 tab 末位且有 ℹ️ 标记"
        }
      ]
    },
    {
      "id": "DT-004",
      "title": "批次面板 (BatchPanel — Agent Teams 可视化)",
      "prdSection": "7.3 (L569-600)",
      "priority": 6,
      "passes": false,
      "dependsOn": [
        "DT-003"
      ],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "BatchPanel.tsx exists",
          "command": "test -f viewer/src/components/BatchPanel.tsx",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        {
          "type": "typecheck",
          "desc": "TypeScript 编译通过"
        },
        {
          "type": "e2e",
          "desc": "并行模式（卡片网格）/ 串行模式（详情卡片）切换；空状态和完成状态正确渲染"
        },
        {
          "type": "manual",
          "desc": "计时器颜色阈值（正常/黄>2x/红>3x）、运行中卡片呼吸动画、完成卡片绿色边框视觉验证"
        }
      ]
    },
    {
      "id": "DT-005",
      "title": "批次时间线 (BatchTimeline)",
      "prdSection": "7.3 (L569-600)",
      "priority": 7,
      "passes": false,
      "dependsOn": [
        "DT-003"
      ],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "BatchTimeline.tsx exists",
          "command": "test -f viewer/src/components/BatchTimeline.tsx",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        {
          "type": "typecheck",
          "desc": "TypeScript 编译通过"
        },
        {
          "type": "e2e",
          "desc": "批次分组渲染（B{n} 标签）、条形宽度比例、颜色编码（绿/脉冲灰/浅灰/红）正确"
        },
        {
          "type": "manual",
          "desc": "自动滚动到执行中批次、当前批次高亮背景 bg-neutral-50 视觉验证"
        }
      ]
    },
    {
      "id": "DT-008",
      "title": "页面集成 + 布局调整",
      "prdSection": "7.4 (L601-618)",
      "priority": 8,
      "passes": false,
      "dependsOn": [
        "DT-004",
        "DT-005",
        "DT-006",
        "DT-007"
      ],
      "evals": [
        {
          "type": "code-based",
          "blocking": true,
          "description": "Typecheck passes",
          "command": "npx tsc --noEmit",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "ESLint passes",
          "command": "cd viewer && npx next lint",
          "expect": "exit-0"
        },
        {
          "type": "code-based",
          "blocking": true,
          "description": "Next.js build passes",
          "command": "cd viewer && npx next build",
          "expect": "exit-0"
        }
      ],
      "testCases": [
        {
          "type": "typecheck",
          "desc": "TypeScript 编译通过"
        },
        {
          "type": "e2e",
          "desc": "完整 Stage 3 Cockpit 布局 + Agent 未运行→运行中→完成全流程状态切换"
        },
        {
          "type": "manual",
          "desc": "1280px 宽度不溢出、1920px 信息密度合理、任务列表展开/Agent启停/阶段切换modal等现有功能不退化"
        }
      ]
    }
  ],
  "sessions": [
    {
      "id": "S1",
      "tasks": [
        "DT-001",
        "DT-002"
      ],
      "reason": "Phase 1 数据层，无前置依赖，DT-001（ProgressStrip）与 DT-002（useTeammates）互相独立，可并行执行"
    },
    {
      "id": "S2",
      "tasks": [
        "DT-003",
        "DT-006",
        "DT-007"
      ],
      "reason": "Phase 2 组件+Hook；DT-003 依赖 DT-002，DT-006/DT-007 无显式依赖但属于 Phase 2，三者在 Phase 2 内可并行执行"
    },
    {
      "id": "S3",
      "tasks": [
        "DT-004",
        "DT-005"
      ],
      "reason": "Phase 3 核心可视化组件，均依赖 DT-003（useTaskTimings），DT-004 和 DT-005 可并行执行"
    },
    {
      "id": "S4",
      "tasks": [
        "DT-008"
      ],
      "reason": "Phase 4 页面集成，依赖所有 Phase 3 组件完成后集成到 stage3/page.tsx，最终验证 typecheck + lint + build"
    }
  ]
}